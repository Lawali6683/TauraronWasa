<!DOCTYPE html>
<html lang="ha">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wasani Masu Zabi</title>
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>

/* üíØ‚úîÔ∏èSite 1 ya fara da nan ‚úîÔ∏è */
body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(to bottom, #180022, #300040);
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-size: cover;
    color: #ffffff;
    transition: background 0.6s, color 0.6s;
}

#main-container {
max-width: 700px;
    margin: 0 auto;
    padding: 10px 12px 30px 12px;
    min-height: 100vh;
         
}


/* Banner */
#banner-section {
    width: 100%;
    min-height: 220px;
    border-radius: 18px;
    overflow: hidden;
    margin-bottom: 10px;
    display: flex;
    gap: 10px;
    background: rgba(0,0,0,0.14);
    align-items: center;
    justify-content: center;
}

#banner-section img, #banner-section video {
    width: 100%;
    max-height: 320px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: transform 0.2s;
}

#banner-section img:hover, #banner-section video:hover {
    transform: scale(1.01);
}

/* Sabon tsarin Teams Display wanda ya fi kyau */
#teams-info {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    background: rgba(24,0,34,0.09);
    border-radius: 10px;
    margin-bottom: 8px;
    padding: 20px 0;
    font-size: 1.2em;
    flex-wrap: wrap;
}

.teams-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    text-align: center;
}

.teams-logo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #5d257a;
    box-shadow: 0 0 10px rgba(93, 37, 122, 0.6);
    background: #fff;
}

.teams-name {
    font-weight: 200;
    color: #ffe7bb;
    font-size: 15px;
}

.teams-score {
    font-weight: 700;
    color: #91fff2;
    font-size: 1.4em;
    margin-top: 10px;
}

.teams-vs {
    font-weight: 700;
    color: #b4a7cf;
    margin: 0 14px;
    font-size: 1.8em;
    letter-spacing: 2px;
}

.teams-box .teams-total {
    background: #2e0040;
    color: #fff;
    border-radius: 8px;
    font-size: 1.5em;
    padding: 2px 8px;
    margin-top: 8px;
}

.teams-box .teams-pick {
    background: #4e0080cc;
    border: none;
    border-radius: 8px;
    color: #ffe7bb;
    font-size: 1.06em;
    cursor: pointer;
    margin-top: 8px;
    padding: 2px 8px;
    transition: background 0.2s;
}

.teams-box .teams-pick.picked {
    background: #23ff97;
    color: #320042;
}

/* üíØ‚úîÔ∏èDaga nan site 1 ya kare ‚úîÔ∏è */
/* üíØ‚úîÔ∏èDaga nan site 2 ya fara ‚úîÔ∏è */

/* Game Text/Audio */
#game-content {
    margin-top: 5px;
    margin-bottom: 6px;
    font-size: 1em;
    font-weight: 500;
    background: rgba(24,0,34,0.09);
    border-radius: 8px;
    padding: 1px 2px;
    white-space: pre-line;
}

.audio-container {
    width: 100%;
    background: #2e0040;
    border-radius: 10px;
    padding: 7px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 6px;
}

.audio-container audio {
    width: 90%;
    height: 32px;
}

#game-meta {
    color: #b4a7cf;
    font-size: 0.96em;
    margin-bottom: 7px;
}

#game-rules {
    background: #220035dd;
    border-radius: 7px;
    margin: 8px 0 7px 0;
    padding: 7px 11px;
    font-size: 0.90em;
    color: #ffe7bb;
    font-weight: 500;
    
}

/* üíØ‚úîÔ∏èSite 2 ya kare daga nan ‚úîÔ∏è */
/* üî±‚úîÔ∏èFooter for comments/reply - site 2 */

/* Sakamakon Wasa Icons */
.comment .result-display {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    margin-top: 10px;
}

.comment .result-display .winner-icon {
    color: #FFD700; /* Gold */
    font-size: 1.5em;
}

.comment .result-display .loser-icon {
    color: #FF4500; /* Red */
    font-size: 1.5em;
}

/* Yanayin bayyanar winner da loser */
.comment.winner-bg {
    background-color: rgba(40,0,60,0.15); /* Keep original background for consistency */
    border-left: 5px solid #28a745;
}

.comment.loser-bg {
    background-color: rgba(40,0,60,0.15);
    border-left: 5px solid #dc3545;
}

/* Sarkin Wasa (Winner) */
.comment.sarki-winner {
    order: -1;
    background: linear-gradient(135deg, #FFD700, #DAA520);
    border: 2px solid gold;
    color: #333;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.comment.sarki-winner .comment-header,
.comment.sarki-winner .comment-body {
    color: #333;
}

/* Emoji container */
#emoji-container {
    position: absolute;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    padding: 8px;
    display: none;
    z-index: 1000;
    flex-wrap: wrap;
    gap: 5px;
}

#emoji-container .emoji-icon {
    cursor: pointer;
    font-size: 20px;
    padding: 4px;
    border-radius: 5px;
}

#emoji-container .emoji-icon:hover {
    background-color: #f0f0f0;
}

/* Wannan shine sabon Profile Viewer da aka gyara */
#modal-viewer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.3s;
}

#modal-viewer.hidden {
    opacity: 0;
    pointer-events: none;
}

.profile-modal-content {
    position: relative;
    max-width: 95%;
    max-height: 95%;
}

.profile-image-fullscreen {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
}

.team-logo-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

/* Sabon Tsarin first-comment-fields-wrapper */
#first-comment-fields-wrapper {
    position: fixed;
    bottom: 70px;
    left: 0;
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
    background: linear-gradient(to bottom, #2e0040cc 0%, #220035dd 100%);
    padding: 8px 10px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 99;
    display: flex;
    justify-content: center;
    align-items: center;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
    box-sizing: border-box;
}

#first-comment-fields-wrapper.hidden {
    display: none !important;
}

/* Tsarin ciki na first-comment-fields */
#first-comment-fields {
    display: flex;
    align-items: center;
    gap: 0px;
    width: 100%;
    justify-content: center;
}

/* Tsarin groups na hoto da suna (team-prediction-group) */
.team-prediction-group {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
}

#first-comment-fields .teams-logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

#first-comment-fields .teams-name {
    font-size: 0px;
    color: #fff;
    white-space: nowrap;
    text-align: center;
}

.first-score-input {
    width: 45px;
    padding: 5px 5px;
    border-radius: 8px;
    border: none;
    background: blue;
    color: #fff;
    font-size: 1.1em;
    text-align: center;
    outline: none;
    margin: 0 5px;
}

/* Tsarin footer-comment ya kasance a kasa */
#footer-comment {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100vw;
    background: linear-gradient(to top, #220035dd 80%, #4e0080cc 100%);
    box-shadow: 0 -2px 16px rgba(28,0,40,0.19);
    padding: 10px 0 14px 0;
    z-index: 100;
}
#comment-container {
    max-width: 700px;
    margin: 0 auto;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding: 0 10px;
}


#upload-btn {
    background: none;
    border: none;
    color: #b4a7cf;
    font-size: 1.5em;
    cursor: pointer;
    margin-bottom: 8px;
    transition: color 0.2s;
}

#upload-btn:hover {
    color: #ffe7bb;
}

#comment-input {
    flex: 1;
    min-height: 36px;
    max-height: 110px;
    border: none;
    border-radius: 12px;
    background: #2e0040;
    color: #fff;
    font-size: 1em;
    padding: 7px 14px;
    resize: none;
    outline: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    transition: background 0.2s, box-shadow 0.2s;
}

#comment-input:focus {
    background: #380061;
    box-shadow: 0 4px 14px rgba(0,0,0,0.13);
}

#send-btn {
    background: none;
    border: none;
    color: #c77dff;
    font-size: 1.47em;
    cursor: pointer;
    margin-bottom: 8px;
    transition: color 0.2s;
    animation: send-bounce 0.9s infinite;
}

#send-btn:disabled {
    color: #7b6b9b;
    animation: none;
}

@keyframes send-bounce {
    0% {
        transform: translateY(0);
    }

    50% {
        transform: translateY(-3px);
    }

    100% {
        transform: translateY(0);
    }
}

/* Notifications */
#notification-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1001;
    display: flex;
    flex-direction: column;
    gap: 10px;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
}

#notification-container.show {
    opacity: 1;
}

.notification-box {
    background-color: #333;
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    text-align: center;
    min-width: 250px;
}

.confirmation-box {
    background-color: #fff;
    color: #333;
}

.confirm-buttons {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
}

.confirm-buttons button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
}

/* üíØ‚úîÔ∏èSite 2 ya kare daga nan ‚úîÔ∏è */


/* üî±‚úîÔ∏èSite 3 ya fara daga nan ‚úîÔ∏è */
/* Comments Section */
#comments-section {
    margin-top: 10px;
    padding-bottom: 80px;
}

/* Comment Container */
.comment { 
    border-radius: 0px;
    margin-bottom: 20px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: box-shadow 0.2s;
    border-left: 4px solid rgba(199, 125, 255, 0.3);
        
}


.comment:hover {
    background: rgba(40, 0, 60, 0.2);
    box-shadow: 0 0 8px rgba(199, 125, 255, 0.2);
}

.comment.user-owned {
    border-left: 3px solid #4dffea;
    background: rgba(40,0,80,0.15);
}

/* Tsarin header na comments */
.comment .comment-header {
    display: flex;
    align-items: center;
    gap: 1px;
    margin-bottom: 6px;
    position: relative;
}

.comment .avatar {
    width: 45px; 
    height: 45px; 
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #c77dff;
    cursor: pointer;
    background: #fff;
    z-index: 1;
}

.comment .team-icon {
    width: 28px; 
    height: 28px; 
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ffecb3;
    background: #fff;
    position: absolute;
    top: -10px; 
    left: 37px; 
    z-index: 2;
}

.comment .user-info {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    position: relative;
    top: -5px;
}

.comment .full-name {
    font-weight: 600;
    font-size: 1.07em;
    color: #ffe7bb;
    max-width: 150px; 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.comment .comment-time {
    font-size: 0.6em;
    color: #c7bfff;
    position: absolute;
    right: 0;
    top: 5%;
    transform: translateY(-50%);
}

.comment .comment-body {
    margin-bottom: 1px;
    margin-left: 1px;
    font-size: 1em;
    color: #fff;
    word-break: break-word;
}

.comment .comment-media {
    margin: 2px 0 2px 50px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.comment .comment-media img,
.comment .comment-media video {
    max-width: 210px;
    max-height: 170px;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.14);
}


.comment .comment-actions .action-btn {
    background: none;
    border: none;
    color: #9f9cff;
    font-size: 1.19em;
    cursor: pointer;
    margin-right: 4px;
    transition: color 0.2s;
    border-bottom: 0.60px solid #4dffea;
}

.comment .comment-actions .action-btn.liked {
    color: #1effc1;
}

.comment .comment-actions .action-btn.seen {
    color: #ffe5a2;
}

.comment .comment-actions .action-btn.emoji {
    font-size: 1.22em;
}

.comment .comment-actions .emoji-list {
    display: flex;
    gap: 5px;
    margin-right: 7px;
    
    
}

/* Tsarin Emoji */
.comment .emoji-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    top: -18px; 
    right: 15px; 
    gap: 5px;
}

.comment .emoji-container span {
    font-size: 1.3em;
    cursor: pointer;
    transition: transform 0.2s;
}

.comment .emoji-container span:hover {
    transform: scale(1.2);
}


.comment .reply-btn:hover {
    background: #33144c;
}

.comment .edit-delete-actions {
    display: flex;
    gap: 7px;
    margin-left: auto;
    margin-right: 10px;
    position: absolute;
    top: 8px;
    right: 0;
}

.comment .edit-delete-actions button {
    background: none;
    border: none;
    color: #ffe7bb;
    cursor: pointer;
    font-size: 1em;
    padding: 3px 7px;
    border-radius: 7px;
    transition: background 0.2s;
}

.comment .edit-delete-actions button:hover {
    background: #5c227c;
}


/* Replies Section */
.replies {
    margin-left: 5px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.reply {
    background: rgba(80,0,120,0.1);
    border-radius: 10px;
    padding: 9px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: box-shadow 0.2s;
    border-left: 3px solid rgba(255, 236, 179, 0.3);
    margin-left: 20px; 
}

.reply:hover {
    background: rgba(80, 0, 120, 0.2);
    box-shadow: 0 0 8px rgba(255, 236, 179, 0.2);
}

.reply.user-owned {
    border-left: 1px solid #4dffea;
    background: rgba(80,0,160,0.15);
}

.reply .reply-by {
    font-size: 0.85em;
    color: #c9c7ff;
    margin-bottom: 5px;
}

.reply .reply-by span {
    color: #ffe7bb;
    font-weight: 600;
}

.reply .reply-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    position: relative;
}
.reply .avatar {
    width: 38px; 
    height: 38px; 
    border-radius: 50%;
    object-fit: cover;
    background: #fff;
    border: 2px solid #c77dff;
    z-index: 1;
}

.reply .team-icon {
    width: 22px;
    height: 22px; 
    border-radius: 50%;
    object-fit: cover;
    background: #fff;
    border: 1px solid #ffecb3;
    position: absolute;
    top: -15px;
    left: 24px; 
    z-index: 2;
}


.reply .reply-media img,
.reply .reply-media video {
    max-width: 170px;
    max-height: 140px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.09);
}


.reply .reply-actions .action-btn {
    background: none;
    border: none;
    color: #ac9cff;
    font-size: 1.09em;
    cursor: pointer;
    margin-right: 3px;
    transition: color 0.2s;
    border-bottom: 0.80px solid #4dffea;
}


.reply .reply-actions .action-btn.liked {
    color: #1effc1;
}

.reply .reply-actions .action-btn.seen {
    color: #ffe5a2;
}

.reply .reply-actions .action-btn.emoji {
    font-size: 1.14em;
}

.reply .reply-actions .emoji-list {
    display: flex;
    gap: 4px;
    margin-right: 5px;
}

/* Tsarin Emoji na replies */
.reply .emoji-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    top: -15px;
    right: 15px; 
    gap: 4px;
}

.reply .emoji-container span {
    font-size: 1.2em;
    cursor: pointer;
    transition: transform 0.2s;
}

.reply .emoji-container span:hover {
    transform: scale(1.2);
}

.reply .edit-delete-actions {
    display: flex;
    gap: 6px;
    margin-left: auto;
    margin-right: 7px;
    position: absolute;
    top: 5px;
    right: 0;
}

.reply .edit-delete-actions button {
    background: none;
    border: none;
    color: #ffe7bb;
    cursor: pointer;
    font-size: 0.98em;
    padding: 2px 6px;
    border-radius: 7px;
    transition: background 0.2s;
}

.reply .edit-delete-actions button:hover {
    background: #5c227c;
}


.comment .comment-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    position: relative; 
}

.comment .comment-time {
    font-size: 0.82em;
    color: #c7bfff;
    margin-left: auto; 
}


.comment .edit-delete-actions {
    display: flex;
    gap: 7px;
    margin-left: auto;
}

/* Tsarin header na replies - An gyara */
.reply .reply-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    position: relative;
}

/* Tsarin lokaci na reply - An gyara */
.reply .reply-time {
    font-size: 0.7em;
    color: #b7bfff;
    margin-left: auto;
}


.reply .edit-delete-actions {
    display: flex;
    gap: 6px;
    margin-left: auto;
}

/* Sabon Style don nuna score na farko */
.score-prediction {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-left: 50px;
    margin-bottom: 10px;
    font-weight: 600;
    color: #ffe7bb;
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(0,0,0,0.1);
}

.score-prediction .score-team-logo {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.3);
}

.score-prediction .score-team-name {
    font-size: 0.9em;
    white-space: nowrap;
}

.score-prediction .score-value {
    font-size: 1.1em;
    color: #91fff2;
}

/* Style for the new emoji container */
#emoji-container {
    position: fixed; 
    background-color: #33004a;
    border: 1px solid #c77dff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    padding: 10px;
    display: none; 
    z-index: 10000; 
    flex-wrap: wrap;
    gap: 8px; 
    max-width: 300px; 
}

#emoji-container .emoji-icon {
    cursor: pointer;
    font-size: 24px;
    padding: 6px;
    border-radius: 5px;
    transition: background-color 0.2s, transform 0.2s;
    color: #ffffff; 
    background-color: rgba(255,255,255,0.05); 
}

#emoji-container .emoji-icon:hover {
    background-color: rgba(255,255,255,0.15); 
    transform: scale(1.1);
}


#emoji-container .close-emoji-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 18px;
    color: #ff4c7d;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
}

#emoji-container .close-emoji-btn:hover {
    transform: scale(1.2);
}



.comment-media video.comment-video,
.reply-media video.reply-video {
    max-width: 100%; 
    height: auto; 
    display: block; 
    border-radius: 8px; 
    margin-top: 10px; 
    object-fit: contain; 
    border: 1px solid rgba(255,255,255,0.1); 
}


.comment-actions, .reply-actions {
    display: flex;
    flex-wrap: wrap; 
    align-items: center;
    gap: 10px; 
    margin-top: 10px;
}

.action-btn {
    background-color: #4a0072; 
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 20px; 
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s ease, transform 0.2s ease;
    display: flex; 
    align-items: center;
    gap: 5px; 
}

.action-btn:hover {
    background-color: #6a0096; 
    transform: translateY(-2px); 
}


#custom-input-modal {
    background-color: #220035e0; 
    color: #fff;
    padding: 22px 36px;
    border-radius: 14px;
    box-shadow: 0 2px 40px rgba(0,0,0,0.33);
    font-size: 1.15em;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

#custom-input-modal h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #ffe7bb;
}

#custom-input-modal span {
    display: block;
    margin-bottom: 10px;
}

#custom-input-field {
    width: calc(100% - 20px); 
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #5d257a;
    background-color: #2e0040;
    color: #fff;
    font-size: 1em;
    outline: none;
}

#custom-input-field:focus {
    border-color: #c77dff;
    box-shadow: 0 0 8px rgba(199, 125, 255, 0.5);
}

#modal-viewer .close-btn {
    position: absolute;
    top: 10px;
    right: 16px;
    color: #ffe7bb;
    font-size: 2.1em;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: color 0.2s;
}

#modal-viewer .close-btn:hover {
    color: #ff4c7d;
}

#notification-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); 
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
}

#notification-container.show {
    opacity: 1;
    pointer-events: auto;
}

.notification-box {  
    position: relative;
}

.confirmation-box {
   
}

.confirm-buttons {
    
}

.reply .reply-main-info .reply-by-user-name {
    font-size: 0.85em;
    color: #c9c7ff; 
    margin-left: 5px; 
    font-weight: normal; 
   
}


.edit-delete-actions {
    display: none; 
    gap: 8px;
    margin-top: 10px;
}

.edit-delete-actions.show-actions {
    display: flex; 
}

.edit-delete-actions button {
    background-color: #555;
    color: #fff;
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em;
    transition: background-color 0.2s ease;
}

.edit-delete-actions .edit-btn:hover {
    background-color: #007bff; 
}

/* üî±‚úîÔ∏èSite 3 ya kare daga nan, ‚úîÔ∏è */



/* üíØ‚úîÔ∏èSite 4 ya fara daga nan ‚úîÔ∏è */

.score-prediction {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: 50px; 
    margin-bottom: 10px;
    font-weight: 600;
    color: #ffe7bb;
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(0,0,0,0.1); 
    flex-wrap: wrap; 
}

.score-prediction .score-team-logo {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.3);
}

.score-prediction .score-team-name {
    font-size: 0.9em;
    white-space: nowrap;
}

.score-prediction .score-value {
    font-size: 1.1em;
    color: #91fff2;
}

/* Modal viewer overlay */
#modal-viewer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(18,0,32,0.87);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

#modal-viewer.hidden {
    display: none;
}

#modal-viewer .modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#modal-viewer img,
#modal-viewer video {
    max-width: 95vw;
    max-height: 80vh;
    border-radius: 14px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.23);
}

#modal-viewer .close-btn {
    position: absolute;
    top: 10px;
    right: 16px;
    color: #ffe7bb;
    font-size: 2.1em;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: color 0.2s;
}

#modal-viewer .close-btn:hover {
    color: #ff4c7d;
}

#modal-viewer .download-btn {
    position: absolute;
    bottom: 12px;
    right: 14px;
    color: #b4a7cf;
    font-size: 1.7em;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: color 0.2s;
}

#modal-viewer .download-btn:hover {
    color: #ffe7bb;
}

/* Notification Modal */
#notification-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    background: #220035e0;
    color: #fff;
    padding: 22px 36px;
    border-radius: 14px;
    z-index: 99999;
    box-shadow: 0 2px 40px #00000033;
    font-size: 1.15em;
    display: none;
}

#notification-modal.active {
    display: block;
}

/* üíØ‚úîÔ∏èSite 4 ya kare daga nan ‚úîÔ∏è */

/* Sakamakon Wasa Icons */
.comment .result-display {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    margin-top: 10px;
}

.comment .result-display .winner-icon {
    color: #FFD700; 
    font-size: 1.5em;
}

.comment .result-display .loser-icon {
    color: #FF4500; 
    font-size: 1.5em;
}


.comment.winner-bg {
    background-color: #e6ffec;
    border-left: 5px solid #28a745;
}

.comment.loser-bg {
    background-color: #ffebeb;
    border-left: 5px solid #dc3545;
}

/* Sarkin Wasa (Winner) */
.comment.sarki-winner {
    order: -1;
    background: linear-gradient(135deg, #FFD700, #DAA520);
    border: 2px solid gold;
    color: #333;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.comment.sarki-winner .comment-header,
.comment.sarki-winner .comment-body {
    color: #333;
}


#emoji-container .emoji-icon {
    cursor: pointer;
    font-size: 20px;
    padding: 4px;
    border-radius: 5px;
}

#emoji-container .emoji-icon:hover {
    background-color: #f0f0f0;
}


#modal-viewer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.3s;
}

#modal-viewer.hidden {
    opacity: 0;
    pointer-events: none;
}

.profile-modal-content {
    position: relative;
    max-width: 95%;
    max-height: 95%;
}

.profile-image-fullscreen {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
}

.team-logo-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

#modal-viewer .close-btn {
    position: absolute;
    top: 0px;
    left: 90%;
    background: none;
    border: none;
    color: red;
    font-size: 3rem;
    cursor: pointer;
    z-index: 1001;
}


#first-comment-fields {
    display: flex;
    align-items: center;
    gap: 10px;
}

#first-comment-fields.hidden {
    display: none !important;
}

/* Notifications */
#notification-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1001;
    display: flex;
    flex-direction: column;
    gap: 10px;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
}

#notification-container.show {
    opacity: 1;
}

.notification-box {
    background-color: #333;
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    text-align: center;
    min-width: 250px;
}

.confirmation-box {
    background-color: #fff;
    color: #333;
}

.confirm-buttons {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
}

.confirm-buttons button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
}



.comment-learnmore {
    color: #4dffea; 
    font-weight: 700;
    cursor: pointer;
    font-size: 0.95em; 
    text-decoration: underline;
    margin-left: 0.3em;
    white-space: nowrap; 
}


.comment-body,
.reply-body {
    overflow: visible !important; 
    display: block !important; 
    -webkit-line-clamp: unset !important; 
    -webkit-box-orient: unset !important; 
}
</style>
  
</head>
<body>
    <!-- üíØ‚úîÔ∏èSite 1 ya fara da nan ‚úîÔ∏è -->
    <div id="main-container">
        <!-- Banner -->
        <div id="banner-section"></div>

        <!-- Teams Display -->
        <div id="teams-info"></div>

        <!-- Game Text/Audio -->
        <div id="game-content"></div>

        <!-- Game Time Meta -->
        <div id="game-meta"></div>
        <div id="game-rules"></div>
        <!-- üíØ‚úîÔ∏èDaga nan site 1 ya kare ‚úîÔ∏è --></div>
        
      
<div id="emoji-container">    
</div>



<div id="notification-container" style="display: none;">
 
</div>

        <!-- üíØ‚úîÔ∏èDaga nan site 2 ya fara ‚úîÔ∏è -->
        <div id="comments-section"></div>
        <!-- üíØ‚úîÔ∏èSite 2 ya kare daga nan ‚úîÔ∏è -->
    </div>

    <!-- üíØ‚úîÔ∏èFooter for comments/reply - site 2 -->
    
<div id="first-comment-fields-wrapper">
    <div id="first-comment-fields">
       
    </div>
</div>


<footer id="footer-comment">
    <div id="comment-container">
        <button id="upload-btn" title="Upload Media"><i class="fas fa-plus"></i></button>
        <textarea id="comment-input" placeholder="Rubuta text..."></textarea>
        <button id="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
    </div>
    <input type="file" id="file-upload" accept="image/*,video/*" multiple style="display:none;">
</footer>
    <!-- üíØ‚úîÔ∏èSite 2 ya kare daga nan ‚úîÔ∏è -->

    <!-- üî±‚úîÔ∏èSite 3 ya fara daga nan ‚úîÔ∏è -->
    <div id="modal-viewer" class="hidden"></div>
    <!-- üî±‚úîÔ∏èSite 3 ya kare daga nan, ‚úîÔ∏è -->

    <!-- üíØ‚úîÔ∏èSite 4 ya fara daga nan ‚úîÔ∏è -->
    <!-- Notification Modal -->
    <div id="notification-modal" class="hidden"></div>
    <!-- üíØ‚úîÔ∏èSite 4 ya kare daga nan ‚úîÔ∏è -->
<script type="module">
  import {
    app,
    analytics,
    firebaseConfig
  } from './firebase.js';
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    push,
    update,
    remove,
    child,
    onValue,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  const db = getDatabase();
  const auth = getAuth();
  let currentUser = null;
  let postCode = null;
  let postData = null;
  let commentsCache = {};
  let currentSarki = null;
  let replyingToOriginalCommentId = null; 
  let replyingToParentReplyId = null; 
const MAX_TEXT_LENGTH_PREVIEW = 300;
const MAX_COMMENT_TEXT_LENGTH = 280; 
const SEEN_POSTS_DAILY_KEY = "tauraronwasa_seen_posts_daily";



  const urlParams = new URLSearchParams(window.location.search);
  postCode = urlParams.get('postCode') || localStorage.getItem('currentPostCode');
  if (postCode) {
    localStorage.setItem('currentPostCode', postCode);
  } else {
    showNotification("An gagara samun lambar wasan. Da fatan za a sake gwadawa.");
  }
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      loadPostData();
      listenCommentsRealtime();
    } else {
      showNotification("Da fatan za a shiga asusunka don ganin wannan wasa.");
    }
  });

  async function checkGameStatusAndAwardWinner() {
    if (!postData || postData.winnerAnnounced) return;

    let gameTimeMs;
    try {
        gameTimeMs = new Date(postData.payGameTime).getTime();
        if (isNaN(gameTimeMs)) {
            console.error("Invalid payGameTime format for game automation:", postData.payGameTime);
            return; // Exit if date is invalid to prevent further errors
        }
    } catch (e) {
        console.error("Error parsing payGameTime for game automation:", e);
        return; // Exit on parsing error
    }
    
    const currentTimeMs = new Date().getTime();
    const timeElapsed = currentTimeMs - gameTimeMs;
    const automationRef = ref(db, `gameAutomation/${postCode}`);

    if (timeElapsed >= 100 * 60 * 1000) { // If 100 minutes have passed since gameTime
      const automationData = (await get(automationRef)).val();
      if (!automationData || automationData.status !== 'completed') {
        checkAndAward();
      }
    } else {
      const timeLeft = gameTimeMs + (100 * 60 * 1000) - currentTimeMs; // Calculate remaining time
      if (timeLeft > 0) {
        setTimeout(checkAndAward, timeLeft);
      }
    }
  }

  async function checkAndAward() {
    const today = new Date().toISOString().slice(0, 10); // Format for API (YYYY-MM-DD)
    const dateFrom = today;
    const dateTo = today;
    const game1Name = postData.game1Name;
    const game2Name = postData.game2Name;
    const apiKey = 'b75541b8a8cc43719195871aa2bd419e';
    let matchResult = await fetchGameResult(apiKey, dateFrom, dateTo, game1Name, game2Name);
    if (!matchResult) {
      setTimeout(async () => {
        matchResult = await fetchGameResult(apiKey, dateFrom, dateTo, game1Name, game2Name);
        if (!matchResult) {
          setTimeout(async () => {
            matchResult = await fetchGameResult(apiKey, dateFrom, dateTo, game1Name, game2Name);
            if (matchResult) {
              await processResults(matchResult);
            }
          }, 10 * 60 * 1000); // Retry after 10 minutes
        } else {
          await processResults(matchResult);
        }
      }, 35 * 60 * 1000); // Retry after 35 minutes
    } else {
      await processResults(matchResult);
    }
  }

  async function fetchGameResult(apiKey, dateFrom, dateTo, game1Name, game2Name) {
    try {
      const response = await fetch(`https://api.football-data.org/v4/matches?dateFrom=${dateFrom}&dateTo=${dateTo}`, {
        headers: {
          'X-Auth-Token': apiKey
        }
      });
      const data = await response.json();
      const match = data.matches.find(match =>
        (match.homeTeam.name === game1Name && match.awayTeam.name === game2Name) ||
        (match.homeTeam.name === game2Name && match.awayTeam.name === game1Name)
      );
      if (match && match.status === 'FINISHED') {
        const homeScore = match.score.fullTime.home;
        const awayScore = match.score.fullTime.away;
        return {
          homeScore,
          awayScore
        };
      }
      return null;
    } catch (error) {
      console.error("Kuskure wajen samun bayanai daga API:", error);
      return null;
    }
  }

  async function processResults(matchResult) {
    const commentsRef = ref(db, `wasaniMasuZabi/${postCode}/Comments`);
    const commentsSnapshot = await get(commentsRef);
    if (!commentsSnapshot.exists()) return;
    let allComments = [];
    commentsSnapshot.forEach(childSnap => {
      allComments.push({
        id: childSnap.key,
        ...childSnap.val()
      });
    });
    let winners = [];
    let losers = [];
    const homeFinalScore = matchResult.homeScore;
    const awayFinalScore = matchResult.awayScore;
    for (const comment of allComments) {
      if (comment.Usergame1box && comment.Usergame2box) {
        if (
          (parseInt(comment.Usergame1box) === homeFinalScore && parseInt(comment.Usergame2box) === awayFinalScore)
        ) {
          winners.push(comment);
        } else {
          losers.push(comment);
        }
      }
    }
    for (const loser of losers) {
      const updateData = {
        resultIcon: '‚öΩüèÖ',
        resultText: 'Wazirin TauraronWasa üèÖ'
      };
      await update(ref(db, `wasaniMasuZabi/${postCode}/Comments/${loser.id}`), updateData);
    }
    if (winners.length > 0) {
      winners.sort((a, b) => new Date(a.commentTime) - new Date(b.commentTime));
      const sarki = winners[0];
      const updateData = {
        resultIcon: 'üèÜüéñÔ∏è‚öΩ‚úîÔ∏è',
        resultText: 'Sarkin wannan Mako Na TauraronWasa üèÜ',
        isSarki: true,
      };
      await update(ref(db, `wasaniMasuZabi/${postCode}/Comments/${sarki.id}`), updateData);
      currentSarki = sarki;
      await update(ref(db, `wasaniMasuZabi/${postCode}`), {
        winnerAnnounced: true,
        sarkiId: sarki.id
      });
      await sendSarkiData(sarki);
    }
    const automationRef = ref(db, `gameAutomation/${postCode}`);
    await update(automationRef, {
      status: 'completed'
    });
  }

  async function sendSarkiData(sarkiData) {
    const payload = {
      userUid: sarkiData.userId,
      fullName: sarkiData.fullName,
      profileLogo: sarkiData.avatarUrl,
      teamLogo: sarkiData.supportTeams,
      commentText: sarkiData.commentText,
      commentTime: sarkiData.commentTime,
      team1Logo: sarkiData.game1logo,
      team1Name: sarkiData.game1Name,
      team2Logo: sarkiData.game2logo,
      team2Name: sarkiData.game2Name,
    };
    try {
      const response = await fetch('https://tauraron-wasa-admin.vercel.app/api/sarki', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': '@haruna66'
        },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      console.log("An tura bayanan sarki:", result);
    } catch (error) {
      console.error("Kuskure wajen tura bayanan sarki:", error);
    }
  }

  function loadPostData() {
    const postRef = ref(db, `wasaniMasuZabi/${postCode}`);
    get(postRef).then(snapshot => {
      if (snapshot.exists()) {
        postData = snapshot.val();
        renderPost(postData);
        localStorage.setItem(`wasa_${postCode}_data`, JSON.stringify(postData));
        checkGameStatusAndAwardWinner();
      } else {
        const gameContent = document.getElementById('game-content');
        if (gameContent) { 
          gameContent.textContent = "Ba a samu post ba.";
        }
      }
    });
  }

  function renderPost(data) {
    const banner = document.getElementById('banner-section');
    if (banner) { 
      banner.innerHTML = '';
      if (data.photalinlink) {
        banner.innerHTML = `<img src="${data.photalinlink}" class="banner-img" alt="Photo" />`;
      }
      banner.querySelectorAll('img').forEach(media => {
        media.onclick = () => showPostViewer(media.src, 'image');
      });
    }

    const teamsInfo = document.getElementById('teams-info');
    if (teamsInfo) { 
      teamsInfo.innerHTML = `
      <div class="teams-box">
        <img src="${data.game1logo}" class="teams-logo" />
        <p class="teams-name">${data.game1Name}</p>
        <span class="teams-total"><i class="fa-solid fa-diamond"></i> ${data.game1box ?? 0}</span>
      </div>
      <span class="teams-vs">VS</span>
      <div class="teams-box">
        <img src="${data.game2logo}" class="teams-logo" />
        <p class="teams-name">${data.game2Name}</p>
        <span class="teams-total"><i class="fa-solid fa-diamond"></i> ${data.game2box ?? 0}</span>
      </div>
    `;
    }

    const gameContent = document.getElementById('game-content');
    if (gameContent) { 
      if (data.test) {
        gameContent.innerHTML = `<div>${data.test}</div>`;
      } else if (data.audioLink) {
        gameContent.innerHTML = `
          <div class="audio-container">
            <audio src="${data.audioLink}" controls></audio>
          </div>
        `;
      } else {
        gameContent.innerHTML = '';
      }
    }

    let gameHasStarted = false;
    let formattedGameTime = '';
    try {
        const gameTime = new Date(data.payGameTime);
        if (!isNaN(gameTime.getTime())) { // Check if the date is valid
            const currentTime = new Date();
            gameHasStarted = currentTime >= gameTime;
            formattedGameTime = `Lokaci: ${formatTime(data.payGameTime)}`;
        } else {
            console.warn("Invalid payGameTime format received for display:", data.payGameTime);
            formattedGameTime = 'Lokacin wasa ba a tantance ba';
        }
    } catch (e) {
        console.error("Error parsing payGameTime for display:", e);
        formattedGameTime = 'Lokacin wasa ba a tantance ba';
    }


    const gameMeta = document.getElementById('game-meta');
    const gameRules = document.getElementById('game-rules');
    const firstCommentFields = document.getElementById('first-comment-fields-wrapper');

    if (gameHasStarted) {
      if (gameMeta) gameMeta.textContent = 'Wasa ya ∆ôare'; 
      if (gameRules) gameRules.innerHTML = 'Wannan wasa ya ∆ôare. Ba za a iya saka maki ba.'; 
      if (firstCommentFields) firstCommentFields.classList.add('hidden'); 
    } else {
      if (gameMeta) gameMeta.textContent = formattedGameTime; 
      if (gameRules) gameRules.innerHTML = `
        Ku yi Sharhi akan wannan wasa Idan kun Samu nasara fadin yadda za a tashi a wannan wasa to kune Sarkin wannan Mako Na TauraronWasa.
        <br><small>Na'ura ce take Gane wanda yayi nasara ta anfani da comment din sa na farko da kuma wada ya fi fadi cikin lokaci.</small>
      `; 
      setupFirstCommentFields(data);
    }
  }

  function setupFirstCommentFields(data) {
    const fieldsWrapper = document.getElementById('first-comment-fields-wrapper');
    const fieldsDiv = document.getElementById('first-comment-fields');
    if (!fieldsWrapper || !fieldsDiv) return; 

    const hasMadePrediction = localStorage.getItem(`wasa_${postCode}_hasMadePrediction_${currentUser.uid}`);
    let gameHasStarted = false;
    try {
        const gameTime = new Date(data.payGameTime);
        if (!isNaN(gameTime.getTime())) {
            const currentTime = new Date();
            gameHasStarted = currentTime >= gameTime;
        } else {
            console.warn("Invalid payGameTime format for setup prediction fields:", data.payGameTime);
        }
    } catch (e) {
        console.error("Error parsing payGameTime for setup prediction fields:", e);
    }

    if (hasMadePrediction || gameHasStarted) {
      fieldsWrapper.classList.add('hidden');
    } else {
      fieldsWrapper.classList.remove('hidden');
      fieldsDiv.innerHTML = `
        <div class="team-prediction-group">
          <img src="${data.game1logo}" class="teams-logo" />
          <span class="teams-name">${data.game1Name}</span>
        </div>
        <input type="number" min="0" max="99" class="first-score-input" id="home-score-input" placeholder="Home">
        <span class="teams-vs">VS</span>
        <input type="number" min="0" max="99" class="first-score-input" id="away-score-input" placeholder="Away">
        <div class="team-prediction-group">
          <img src="${data.game2logo}" class="teams-logo" />
          <span class="teams-name">${data.game2Name}</span>
        </div>
      `;
    }
  }

  const commentInput = document.getElementById('comment-input');
  const uploadBtn = document.getElementById('upload-btn');
  const sendBtn = document.getElementById('send-btn');
  const fileUpload = document.getElementById('file-upload');
  let selectedFiles = [];

  if (uploadBtn) uploadBtn.addEventListener('click', () => fileUpload.click()); 
  if (fileUpload) fileUpload.addEventListener('change', e => { 
    selectedFiles = Array.from(e.target.files).slice(0, 3);
  });
  if (commentInput) commentInput.addEventListener('input', () => { 
    commentInput.style.height = '36px';
    commentInput.style.height = Math.min(commentInput.scrollHeight, 110) + 'px';
    if (sendBtn) sendBtn.disabled = !commentInput.value.trim() && selectedFiles.length === 0; 
  });
  if (sendBtn) sendBtn.addEventListener('click', handleSendComment); 

  // Generic fetch with retry for external API calls
  async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          if (response.status >= 500 || !response.status) { 
            throw new Error(`Server error or network issue: ${response.status || 'No Status'}`);
          } else {
            console.warn(`Client error, no retry: ${response.status} - ${await response.text()}`);
            return null;
          }
        }
        return response; 
      } catch (error) {
        console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying...`);
        if (i < retries - 1) { 
          await new Promise(res => setTimeout(res, delay * Math.pow(2, i))); 
        }
      }
    }
    console.error(`All ${retries} fetch retries failed for ${url}.`);
    return null;
  }

  // Function to send user notification to worker33.workers.dev
  async function sendUserNotification(recipientUid, senderData, replyTextSnippet, originalCommentId, parentReplyId) {
    try {
      // 1. Get recipient's data (subscription, userIpAddress, fullName) from Firebase
      const recipientUserRef = ref(db, `users/${recipientUid}`);
      const recipientSnapshot = await get(recipientUserRef);
      const recipientData = recipientSnapshot.exists() ? recipientSnapshot.val() : null;

      // Check if recipient has necessary notification data
      if (!recipientData || !recipientData.subscription || !recipientData.userIpAddress) {
        console.warn(`Recipient ${recipientUid} does not have complete notification data (subscription, IP, or full name).`);
        return; // Exit if required data is missing
      }

      const recipientSubscription = recipientData.subscription; 
      const recipientIpAddress = recipientData.userIpAddress; 
      const recipientFullName = recipientData.fullName || 'Unknown User'; 

      // 2. Construct the payload for worker33.workers.dev/userNotification
      const payload = {
        recipientSubscription: recipientSubscription,
        recipientFullName: recipientFullName, 
        recipientIpAddress: recipientIpAddress, 
        title: `Sabon Reply Daga ${senderData.fullName}`,
        body: replyTextSnippet.substring(0, 100) + (replyTextSnippet.length > 100 ? '...' : ''), 
        icon: senderData.profileLogo, 
        badge: senderData.teamLogo, 
        url: `${window.location.origin}${window.location.pathname}?postCode=${postCode}#comment-${originalCommentId}`, 
      };

      // Customize body for reply-to-reply scenario
      if (parentReplyId) {
        payload.body = `Reply ga Reply: ${replyTextSnippet.substring(0, 100)}${(replyTextSnippet.length > 100 ? '...' : '')}`;
      }

      console.log("Sending notification payload:", payload);

      // 3. Send the request to your worker API
      const response = await fetchWithRetry('https://worker33.workers.dev/userNotification', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });

      if (response && response.ok) {
        console.log("Notification sent successfully to worker.");
      } else {
        console.warn("Failed to send notification to worker.");
      }

    } catch (error) {
      console.error("Error in sendUserNotification:", error);
    }
  }


  async function handleSendComment() {
    if (!currentUser) return;
    if (sendBtn) sendBtn.disabled = true; 

    let commentMediaLinks = { images: [], video: null };
    let commentText = commentInput ? commentInput.value.trim() : '';

    if (!commentText && selectedFiles.length === 0) {
      if (sendBtn) sendBtn.disabled = false; 
      return;
    }

    // --- START: Imgur Upload Logic ---
    if (selectedFiles.length > 0) {
      for (const file of selectedFiles) {
        const formData = new FormData();
        formData.append("image", file); // Imgur API uses 'image' field for both images and videos

        try {
          const response = await fetch("https://api.imgur.com/3/image", {
            method: "POST",
            headers: {
              Authorization: "Client-ID 5acf7eff9c91660" // Your Imgur Client ID
            },
            body: formData
          });
          const data = await response.json();
          if (data.success && data.data && data.data.link) {
            if (file.type.startsWith("image/")) {
              commentMediaLinks.images.push(data.data.link);
            } else if (file.type.startsWith("video/")) {
              commentMediaLinks.video = data.data.link; // Only one video allowed
            }
          } else {
            console.error("Imgur upload failed for file:", file.name, data);
            showNotification(`An kasa loda hoton/bidiyon '${file.name}'.`);
          }
        } catch (uploadError) {
          console.error("Error uploading to Imgur:", uploadError);
          showNotification(`An sami kuskure wajen loda hoton/bidiyon '${file.name}'.`);
        }
      }
    }
    // --- END: Imgur Upload Logic ---

    const homeScore = document.getElementById('home-score-input') ? document.getElementById('home-score-input').value : null;
    const awayScore = document.getElementById('away-score-input') ? document.getElementById('away-score-input').value : null;
    let isFirstCommentPrediction = !!homeScore && !!awayScore;

    try {
      const commentsRef = ref(db, `wasaniMasuZabi/${postCode}/Comments`);
      let recipientUidForNotification = null; 

      if (replyingToOriginalCommentId) { // If it's a reply to an existing comment or another reply
        const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);

        if (originalComment) {
            if (replyingToParentReplyId) { // Replying to a specific reply
                if (originalComment.replies) {
                    const parentReply = Object.values(originalComment.replies).find(r => r.id === replyingToParentReplyId);
                    if (parentReply) {
                        recipientUidForNotification = parentReply.userId; // Notify the owner of the parent reply
                    }
                }
            } else { // Replying directly to the main comment
                recipientUidForNotification = originalComment.userId; // Notify the owner of the main comment
            }
        }

        // Prepare reply object for Firebase
        let replyObj = {
          userId: currentUser.uid,
          avatarUrl: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
          supportTeams: postData.supportTeams || '',
          fullName: currentUser.displayName || 'Unknown User',
          commentText: commentText, // Use 'commentText' for reply content (consistent field name)
          imageLink1: commentMediaLinks.images[0] || '', // Media links from Imgur
          imageLink2: commentMediaLinks.images[1] || '',
          imageLink3: commentMediaLinks.images[2] || '',
          videoComment: commentMediaLinks.video || '',
          replyTime: new Date().toISOString(),
          replyLike: 0,
          userFirebaseUid: currentUser.uid,
          replyingToCommentId: replyingToOriginalCommentId, 
          replyingToReplyId: replyingToParentReplyId, 
        };

        // Determine the full name of the user being replied to for display in the reply body itself
        if (replyingToParentReplyId) {
            const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);
            if (originalComment && originalComment.replies) {
                const parentReply = Object.values(originalComment.replies).find(r => r.id === replyingToParentReplyId);
                if (parentReply) {
                    replyObj.replyingToReplyUserFullName = parentReply.fullName;
                }
            }
        } else { 
             const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);
             if (originalComment) {
                 replyObj.replyingToReplyUserFullName = originalComment.fullName;
             }
        }
        
        const repliesRef = child(commentsRef, `${replyingToOriginalCommentId}/replies`);
        const newReplyRef = push(repliesRef);
        await set(newReplyRef, replyObj);
        showNotification("An ajiye reply naka.");

        // Send notification if the recipient is different from the current sender
        if (recipientUidForNotification && recipientUidForNotification !== currentUser.uid) {
            const senderData = {
                fullName: currentUser.displayName || 'Unknown User',
                profileLogo: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
                teamLogo: postData.supportTeams || 'https://i.imgur.com/CgvdgMA.png', 
            };
            await sendUserNotification(recipientUidForNotification, senderData, commentText, replyingToOriginalCommentId, replyingToParentReplyId);
        }

      } else { // It's a new top-level comment
        const commentObj = {
          userId: currentUser.uid,
          avatarUrl: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
          supportTeams: postData.supportTeams || '',
          fullName: currentUser.displayName || 'Unknown User',
          commentText: commentText,
          imageLink1: commentMediaLinks.images[0] || '',
          imageLink2: commentMediaLinks.images[1] || '',
          imageLink3: commentMediaLinks.images[2] || '',
          videoComment: commentMediaLinks.video || '',
          commentTime: new Date().toISOString(),
          commentLike: 0,
          commentEmoji: '',
          replies: {},
          game1Name: postData.game1Name,
          game1logo: postData.game1logo,
          Usergame1box: isFirstCommentPrediction ? homeScore : null,
          Usergame2box: isFirstCommentPrediction ? awayScore : null,
          game2logo: postData.game2logo,
          game2Name: postData.game2Name,
          userFirebaseUid: currentUser.uid,
          resultIcon: null,
          resultText: null,
          isSarki: false,
          isFirstCommentPrediction: isFirstCommentPrediction,
        };
        const newCommentRef = push(commentsRef);
        await set(newCommentRef, commentObj);
        if (isFirstCommentPrediction) {
          localStorage.setItem(`wasa_${postCode}_hasMadePrediction_${currentUser.uid}`, 'true');
        }
        
      }
      
      // Increment totalComment for both comments and replies after successful save
      const postTotalCommentsRef = ref(db, `wasaniMasuZabi/${postCode}/totalComment`);
      await runTransaction(postTotalCommentsRef, (currentTotal) => {
          return (currentTotal || 0) + 1;
      });

    } catch (err) {
      console.warn("Kuskure wajen ajiye comment:", err);
      
    }

    // Reset comment input and state after sending
    if (commentInput) {
      commentInput.value = '';
      commentInput.style.height = '36px'; 
      commentInput.placeholder = "Rubuta comment‚Ä¶"; 
    }
    replyingToOriginalCommentId = null; 
    replyingToParentReplyId = null; 
    selectedFiles = [];
    if (fileUpload) fileUpload.value = ''; 
    if (sendBtn) sendBtn.disabled = false; 
    setupFirstCommentFields(postData); 
  }

  function listenCommentsRealtime() {
    const commentsRef = ref(db, `wasaniMasuZabi/${postCode}/Comments`);
    onValue(commentsRef, snapshot => {
      let comments = [];
      snapshot.forEach(childSnap => {
        let comment = childSnap.val();
        comment.id = childSnap.key;
        comments.unshift(comment);
      });
      commentsCache = comments;
      renderComments(comments);
    });
  }

  function renderComments(comments) {
    const section = document.getElementById('comments-section');
    if (!section) return; 
    section.innerHTML = '';
    const sarkiComment = comments.find(c => c.isSarki);
    const loserComments = comments.filter(c => c.resultIcon === '‚öΩüôÑ‚ùå');
    const otherComments = comments.filter(c => !c.isSarki && c.resultIcon !== '‚öΩüôÑ‚ùå');
    if (sarkiComment) {
      section.append(renderComment(sarkiComment, true));
    }
    loserComments.forEach(comment => {
      section.append(renderComment(comment));
    });
    otherComments.forEach(comment => {
      section.append(renderComment(comment));
    });
    localStorage.removeItem(`wasa_${postCode}_comments`);
  }

  function renderComment(comment, isSarki = false) {
    const div = document.createElement('div');
    div.className = `comment ${comment.userId === currentUser.uid ? 'user-owned' : ''} ${isSarki ? 'sarki-winner' : ''} ${comment.resultIcon === 'üèÜüéñÔ∏è‚öΩ‚úîÔ∏è' ? 'winner-bg' : ''} ${comment.resultIcon === '‚öΩüôÑ‚ùå' ? 'loser-bg' : ''}`;
    div.dataset.commentId = comment.id;
    let resultHtml = '';
    if (comment.resultIcon) {
      const icon = comment.resultIcon === '‚öΩüôÑ‚ùå' ? '<i class="fas fa-times-circle loser-icon"></i>' : '<i class="fas fa-medal winner-icon"></i>';
      resultHtml = `
        <div class="result-display">
          ${icon}
          <span>${comment.resultText}</span>
        </div>
      `;
    }
    
                   
    let commentBodyText = comment.commentText || '';
    let displayCommentText = commentBodyText;
    let hasMoreCommentText = false;

    if (commentBodyText.length > MAX_COMMENT_TEXT_LENGTH) {
        displayCommentText = commentBodyText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...'; // ∆òara '...'
        hasMoreCommentText = true;
    }

    div.innerHTML = `
        <div class="comment-header">
            <div class="avatar-wrapper">
                <img src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="avatar" data-profile-src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
                <img src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" class="team-icon" data-profile-src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
            </div>
            <div class="comment-main-info">
                <span class="full-name">${comment.fullName}</span>
                <span class="comment-time">${formatTime(comment.commentTime)}</span>
            </div>
        </div>
        <div class="comment-body" data-fulltext="${encodeURIComponent(commentBodyText)}">
            ${displayCommentText}
            ${hasMoreCommentText ? `<span class="comment-learnmore">Kara Karantawa</span>` : ''}
        </div>
        <div class="comment-media">
            ${comment.imageLink1 ? `<img src="${comment.imageLink1}" class="comment-img" onerror="this.style.display='none'" />` : ''}
            ${comment.imageLink2 ? `<img src="${comment.imageLink2}" class="comment-img" onerror="this.style.display='none'" />` : ''}
            ${comment.imageLink3 ? `<img src="${comment.imageLink3}" class="comment-img" onerror="this.style.display='none'" />` : ''}
            ${comment.videoComment ? `<video src="${comment.videoComment}" class="comment-video" controls onerror="this.style.display='none'"></video>` : ''}
        </div>
        <div class="comment-actions">
            <button class="action-btn like-btn">Like. ${comment.commentLike || 0}</button>
            <button class="action-btn emoji-btn">Emoji <span class="emoji-text">${comment.commentEmoji || ''}</span></button>
            <button class="action-btn reply-btn">Reply</button>
            ${comment.userId === currentUser.uid ? `<button class="action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
        </div>
        <div class="edit-delete-actions" style="display: none;">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
        </div>
    `;

    // Wannan shine wurin da zaka saka Event Listener don "Kara Karantawa" a cikin renderComment
    const commentBodyElement = div.querySelector('.comment-body');
    const commentLearnMoreBtn = commentBodyElement ? commentBodyElement.querySelector('.comment-learnmore') : null;

    if (commentLearnMoreBtn) {
        commentLearnMoreBtn.addEventListener('click', () => {
            const fullText = decodeURIComponent(commentBodyElement.dataset.fulltext);
            commentBodyElement.innerHTML = fullText; // Nuna dukkan text
        });
    }

    const likeBtn = div.querySelector('.like-btn');
    if (likeBtn) likeBtn.addEventListener('click', (e) => { 
      e.stopPropagation(); 
      handleLike(comment.id);
    });
    const replyBtn = div.querySelector('.reply-btn');
    if (replyBtn) replyBtn.addEventListener('click', (e) => { 
      e.stopPropagation(); 
      handleReply(comment.id); 
    });
    const emojiBtn = div.querySelector('.emoji-btn');
    if (emojiBtn) emojiBtn.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        handleEmojiClick(e, comment.id, 'comment');
    });

    const moreOptionsBtn = div.querySelector('.more-options-btn');
    const editDeleteActionsDiv = div.querySelector('.edit-delete-actions');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            if (editDeleteActionsDiv) {
                editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
                editDeleteActionsDiv.classList.toggle('show-actions'); 
            }
        });
    }

    const avatar = div.querySelector('.avatar');
    if (avatar) avatar.onclick = (e) => showProfileViewer(e.target.dataset.src, e.target.dataset.teamSrc);
    const teamIcon = div.querySelector('.team-icon');
    if (teamIcon) teamIcon.onclick = (e) => showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.src);

    if (comment.userId === currentUser.uid) { 
      const editBtn = div.querySelector('.edit-btn');
      if (editBtn) editBtn.addEventListener('click', async (e) => { 
        e.stopPropagation(); 
        const newText = await showInputModal("Gyara comment:", "Rubuta sabon comment din ka:", comment.commentText);
        if (newText !== null && newText.trim() !== "") {
            handleEdit(comment.id, newText);
        }
        // Ensure actions hide after edit attempt
        if (editDeleteActionsDiv) {
            editDeleteActionsDiv.style.display = 'none';
            editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) deleteBtn.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        handleDelete(comment.id);
        // Ensure actions hide after delete attempt
        if (editDeleteActionsDiv) {
            editDeleteActionsDiv.style.display = 'none';
            editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
    }
    const repliesDiv = document.createElement('div');
    repliesDiv.className = 'replies';
    if (comment.replies) {
      const sortedReplies = Object.values(comment.replies).sort((a, b) => new Date(a.replyTime) - new Date(b.replyTime));
      sortedReplies.forEach(reply => {
        repliesDiv.append(renderReply(reply, comment)); 
      });
    }
    div.append(repliesDiv);
    return div;
  }

  function showPostViewer(src, type) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) return;
    modal.innerHTML = `
      <div class="modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <img src="${src}" />
        <button class="download-btn" title="Download"><i class="fas fa-download"></i></button>
      </div>
    `;
    modal.classList.remove('hidden');
    const closeBtn = modal.querySelector('.close-btn');
    if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
    const downloadBtn = modal.querySelector('.download-btn');
    if (downloadBtn) downloadBtn.onclick = () => downloadMedia(src, type);
  }

  function showCommentMediaViewer(src, type) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) return;
    modal.innerHTML = `
      <div class="modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        ${type === 'image' ? `<img src="${src}" />` : `<video src="${src}" controls autoplay></video>`}
      </div>
    `;
    modal.classList.remove('hidden');
    const closeBtn = modal.querySelector('.close-btn');
    if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
  }

  function showProfileViewer(profileUrl, teamUrl) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) return;
    modal.innerHTML = `
      <div class="profile-modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <img src="${profileUrl}" class="profile-image-fullscreen" />
        <img src="${teamUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="team-logo-overlay" />
      </div>
    `;
    modal.classList.remove('hidden');
    const closeBtn = modal.querySelector('.close-btn');
    if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
  }

  function renderReply(reply, parentComment) {
    const div = document.createElement('div');
    div.className = `reply ${reply.userId === currentUser.uid ? 'user-owned' : ''}`;
    div.dataset.replyId = reply.id;
    
    // Determine the user being replied to for display purposes
    let replyingToHtml = '';
    if (reply.replyingToReplyUserFullName) {
      replyingToHtml = `<span class="reply-by-user-name">Replying to ${reply.replyingToReplyUserFullName}</span>`;
    } else {
      replyingToHtml = `<span class="reply-by-user-name">Replying to ${parentComment.fullName}</span>`;
    }
  
    let replyBodyText = reply.commentText || '';
    let displayReplyText = replyBodyText;
    let hasMoreReplyText = false;

    if (replyBodyText.length > MAX_COMMENT_TEXT_LENGTH) {
        displayReplyText = replyBodyText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...'; // ∆òara '...'
        hasMoreReplyText = true;
    }

    div.innerHTML = `
        <div class="reply-header">
            <div class="avatar-wrapper">
                <img src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="avatar" data-profile-src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
                <img src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" class="team-icon" data-profile-src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
            </div>
            <div class="reply-main-info">
                <span class="full-name">${reply.fullName}</span>
                ${replyingToHtml}
                <span class="reply-time">${formatTime(reply.replyTime)}</span>
            </div>
        </div>
        <div class="reply-body" data-fulltext="${encodeURIComponent(replyBodyText)}">
            ${displayReplyText}
            ${hasMoreReplyText ? `<span class="comment-learnmore">Kara Karantawa</span>` : ''}
        </div>
        <div class="reply-media">
            ${reply.imageLink1 ? `<img src="${reply.imageLink1}" class="reply-img" onerror="this.style.display='none'" />` : ''}
            ${reply.imageLink2 ? `<img src="${reply.imageLink2}" class="reply-img" onerror="this.style.display='none'" />` : ''}
            ${reply.imageLink3 ? `<img src="${reply.imageLink3}" class="reply-img" onerror="this.style.display='none'" />` : ''}
            ${reply.videoComment ? `<video src="${reply.videoComment}" class="reply-video" controls onerror="this.style.display='none'"></video>` : ''}
        </div>
        <div class="reply-actions">
            
            <button class="action-btn reply-btn">Reply</button>
            ${reply.userId === currentUser.uid ? `<button class="action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
        </div>
        <div class="edit-delete-actions" style="display: none;">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
        </div>
    `;

    // Wannan shine wurin da zaka saka Event Listener don "Kara Karantawa" a cikin renderReply
    const replyBodyElement = div.querySelector('.reply-body');
    const replyLearnMoreBtn = replyBodyElement ? replyBodyElement.querySelector('.comment-learnmore') : null;

    if (replyLearnMoreBtn) {
        replyLearnMoreBtn.addEventListener('click', () => {
            const fullText = decodeURIComponent(replyBodyElement.dataset.fulltext);
            replyBodyElement.innerHTML = fullText; // Nuna dukkan text
        });
    }
    
    const likeBtn = div.querySelector('.like-btn');
    if (likeBtn) likeBtn.addEventListener('click', (e) => { 
      e.stopPropagation(); 
      handleLikeReply(parentComment.id, reply.id);
    });
    const replyBtn = div.querySelector('.reply-btn'); 
    if (replyBtn) replyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleReply(parentComment.id, reply.id); 
    });

    const moreOptionsBtn = div.querySelector('.more-options-btn');
    const editDeleteActionsDiv = div.querySelector('.edit-delete-actions');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            if (editDeleteActionsDiv) {
                editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
                editDeleteActionsDiv.classList.toggle('show-actions'); 
            }
        });
    }

    const avatar = div.querySelector('.avatar');
    if (avatar) avatar.onclick = (e) => showProfileViewer(e.target.dataset.src, e.target.dataset.teamSrc);
    const teamIcon = div.querySelector('.team-icon');
    if (teamIcon) teamIcon.onclick = (e) => showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.src);

    if (reply.userId === currentUser.uid) { 
      const editBtn = div.querySelector('.edit-btn');
      if (editBtn) editBtn.addEventListener('click', async (e) => { 
        e.stopPropagation(); 
        const newText = await showInputModal("Gyara reply:", "Rubuta sabon reply din ka:", reply.commentText); 
        if (newText !== null && newText.trim() !== "") {
            handleEditReply(parentComment.id, reply.id, newText);
        }
        // Ensure actions hide after edit attempt
        if (editDeleteActionsDiv) {
            editDeleteActionsDiv.style.display = 'none';
            editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) deleteBtn.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        handleDeleteReply(parentComment.id, reply.id);
        // Ensure actions hide after delete attempt
        if (editDeleteActionsDiv) {
            editDeleteActionsDiv.style.display = 'none';
            editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
    }
    return div;
  }

  function handleLike(commentId) {
    const commentRef = ref(db, `wasaniMasuZabi/${postCode}/Comments/${commentId}`);
    runTransaction(commentRef, (comment) => {
      if (comment) {
        if (!comment.commentLike) {
          comment.commentLike = 0;
        }
        comment.commentLike++;
      }
      return comment;
    });
  }

  // Function to handle likes for replies
  function handleLikeReply(commentId, replyId) {
    const replyRef = ref(db, `wasaniMasuZabi/${postCode}/Comments/${commentId}/replies/${replyId}`);
    runTransaction(replyRef, (reply) => {
      if (reply) {
        if (!reply.replyLike) {
          reply.replyLike = 0;
        }
        reply.replyLike++;
      }
      return reply;
    });
  }

  function handleReply(commentId, parentReplyId = null) { 
    replyingToOriginalCommentId = commentId;
    replyingToParentReplyId = parentReplyId; 

    const originalComment = commentsCache.find(c => c.id === commentId);
    let targetUserName = originalComment ? originalComment.fullName : 'Unknown User';

    if (parentReplyId) { 
        if (originalComment && originalComment.replies) {
            const parentReply = Object.values(originalComment.replies).find(r => r.id === parentReplyId);
            if (parentReply) {
                targetUserName = parentReply.fullName;
            }
        }
    }
    
    if (commentInput) {
      commentInput.placeholder = `Replying to ${targetUserName}...`;
      commentInput.focus();
    }
  }

  // handleEmojiClick remains unchanged (only for comments)
  function handleEmojiClick(event, commentId, type, replyId = null) {
    event.stopPropagation(); 

    const emojiContainer = document.getElementById('emoji-container');
    if (!emojiContainer) {
      console.error("Emoji container not found. Make sure you have a div with id 'emoji-container' in your HTML.");
      return;
    }

    const rect = event.currentTarget.getBoundingClientRect();
    
    emojiContainer.style.position = 'fixed'; 
    let topPosition = rect.bottom + 10;
    if (topPosition + emojiContainer.offsetHeight > window.innerHeight && rect.top - emojiContainer.offsetHeight - 10 > 0) {
        topPosition = rect.top - emojiContainer.offsetHeight - 10; 
    }
    emojiContainer.style.top = `${topPosition}px`;
    emojiContainer.style.left = `${rect.left}px`;
    emojiContainer.style.transform = 'translateX(0)'; 
    
    if (rect.left + emojiContainer.offsetWidth > window.innerWidth) {
        emojiContainer.style.left = `${window.innerWidth - emojiContainer.offsetWidth - 10}px`; 
    }

    emojiContainer.style.maxWidth = '300px'; 
    emojiContainer.style.display = 'flex';
    emojiContainer.classList.add('show'); 


    const emojiIcons = ['üëç', 'ü§¶‚Äç‚ôÄÔ∏è', 'üëÅÔ∏è', '‚ùå', 'üôÜ‚Äç‚ôÇÔ∏è', 'ü§ö', 'ü§ú', 'üòÜ', 'üòÑ', 'üò†', 'üò°', 'üëπ', 'üôâ', 'üíû', '‚ù§Ô∏è', 'üíØ', 'üí•', 'üë©‚Äçüé§', 'üë©‚Äçüåæ', 'üôã‚Äç‚ôÄÔ∏è', 'üêí', 'ü¶ç', 'üê´', 'ü¶ì', 'ü¶Ñ', 'üêü', '‚öΩ', 'üèÖ', 'üèÜ', 'ü•á', 'üéâ', 'üéä', 'üéÅ'];
    
    let emojiHtml = `<span class="emoji-icon close-emoji-btn">‚ùå</span>`; 
    emojiHtml += emojiIcons.map(icon => `<span class="emoji-icon">${icon}</span>`).join('');
    emojiContainer.innerHTML = emojiHtml;


    emojiContainer.querySelectorAll('.emoji-icon').forEach(icon => {
      icon.onclick = (e) => { 
        e.stopPropagation(); 
        emojiContainer.style.display = 'none'; 
        emojiContainer.classList.remove('show'); 
        if (!icon.classList.contains('close-emoji-btn')) { 
            updateEmoji(commentId, icon.textContent, type, replyId);
        }
      };
    });
  }

  // updateEmoji remains unchanged (only for comments)
  function updateEmoji(commentId, emoji, type, replyId) {
    let path = `wasaniMasuZabi/${postCode}/Comments/${commentId}`;
    if (type === 'comment') { 
        const emojiRef = ref(db, path);
        update(emojiRef, {
            [`${type}Emoji`]: emoji
        });
    }
  }

  // showInputModal remains unchanged
  function showInputModal(title, message, defaultValue = '') {
    return new Promise((resolve) => {
      const modalHtml = `
        <div id="custom-input-modal" class="notification-box confirmation-box">
          <h3>${title}</h3>
          <span>${message}</span>
          <input type="text" id="custom-input-field" value="${defaultValue}" style="width: 90%; padding: 8px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc;"/>
          <div class="confirm-buttons" style="margin-top: 15px;">
            <button id="input-confirm-ok" style="background-color: #28a745;">OK</button>
            <button id="input-confirm-cancel" style="background-color: #dc3545;">A'a</button>
          </div>
        </div>
      `;
      const container = document.getElementById('notification-container');
      if (!container) {
          console.error("Notification container not found for input modal.");
          return resolve(null);
      }
      container.innerHTML = ''; 
      container.innerHTML = modalHtml;
      container.classList.add('show');

      const inputField = document.getElementById('custom-input-field');
      if (inputField) inputField.focus();

      document.getElementById('input-confirm-ok').onclick = () => {
        const value = inputField ? inputField.value : '';
        container.classList.remove('show');
        container.innerHTML = ''; 
        resolve(value);
      };

      document.getElementById('input-confirm-cancel').onclick = () => {
        container.classList.remove('show');
        container.innerHTML = ''; 
        resolve(null);
      };
    });
  }

  function handleEdit(commentId, newText) {
    const commentRef = ref(db, `wasaniMasuZabi/${postCode}/Comments/${commentId}`);
    update(commentRef, {
        commentText: newText
    });
    showNotification("An gyara comment naka.");
  }

  function handleDelete(commentId) {
    showConfirmation("Kana so ka goge wannan comment?", () => {
      const commentRef = ref(db, `wasaniMasuZabi/${postCode}/Comments/${commentId}`);
      remove(commentRef).then(() => {
        showNotification("An goge comment naka.");
      }).catch(error => {
        console.error("Kuskure wajen goge comment:", error);
        showNotification("An kasa goge comment.");
      });
    });
  }

  function handleEditReply(commentId, replyId, newText) {
    const replyRef = ref(db, `wasaniMasuZabi/${postCode}/Comments/${commentId}/replies/${replyId}`);
    update(replyRef, {
        commentText: newText 
    });
    showNotification("An gyara reply naka.");
  }

  function handleDeleteReply(commentId, replyId) {
    showConfirmation("Kana so ka goge wannan reply?", () => {
      const replyRef = ref(db, `wasaniMasuZabi/${postCode}/Comments/${commentId}/replies/${replyId}`);
      remove(replyRef).then(() => {
        showNotification("An goge reply naka.");
      }).catch(error => {
        console.error("Kuskure wajen goge reply:", error);
        showNotification("An kasa goge reply.");
      });
    });
  }

  function downloadMedia(src, type) {
    // Logic for downloading media (not modified)
  }

  function showNotification(message) {
    const container = document.getElementById('notification-container');
    if (!container) return; 
    container.innerHTML = ''; 
    const notificationBox = document.createElement('div');
    notificationBox.className = 'notification-box';
    notificationBox.textContent = message;
    container.append(notificationBox);

    container.classList.add('show');
    setTimeout(() => {
      container.classList.remove('show');
      container.innerHTML = ''; 
    }, 5000);
  }

  function showConfirmation(message, onConfirm) {
    const container = document.getElementById('notification-container');
    if (!container) return; 
    container.innerHTML = '';
    const confirmationBox = document.createElement('div');
    confirmationBox.className = 'notification-box confirmation-box';
    confirmationBox.innerHTML = `
        <span>${message}</span>
        <div class="confirm-buttons">
          <button id="confirm-yes">Eh</button>
          <button id="confirm-no">A'a</button>
        </div>
    `;
    container.append(confirmationBox);
    container.classList.add('show');

    const confirmYesBtn = document.getElementById('confirm-yes');
    if (confirmYesBtn) { 
      confirmYesBtn.onclick = () => {
        onConfirm();
        container.classList.remove('show');
        container.innerHTML = ''; 
      };
    }
    const confirmNoBtn = document.getElementById('confirm-no');
    if (confirmNoBtn) { 
      confirmNoBtn.onclick = () => {
        container.classList.remove('show');
        container.innerHTML = ''; 
      };
    }
  }

  function formatTime(dateStr) {
    const dt = new Date(dateStr);
    return dt.toLocaleString('ha-NG', {
      hour12: true
    });
  }

  document.addEventListener('click', (event) => {
    const emojiContainer = document.getElementById('emoji-container');
    if (emojiContainer && emojiContainer.style.display === 'flex') {
        if (!emojiContainer.contains(event.target) && !event.target.closest('.emoji-btn')) {
            emojiContainer.style.display = 'none';
            emojiContainer.classList.remove('show'); 
        }
    }
  });
</script>
</body>
</html>