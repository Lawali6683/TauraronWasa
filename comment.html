<!DOCTYPE html>
<html lang="ha">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KaiTsaye Post</title>
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        
        /* ğŸ’¥âœ”ï¸Site 1, ya fara daga nan, âœ”ï¸ */
body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(to bottom, #180022, #300040);
    background-repeat: no-repeat;
    background-attachment: fixed; 
    background-size: cover;
    color: #ffffff;
    transition: background 0.6s, color 0.6s;
}

header#header-bar {
    background: #220035e0;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px 7px 16px;
    justify-content: space-between;
}
#logo-img {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #fff;
    object-fit: cover;
    box-shadow: 0 2px 12px #0003;
}
#audio-toggle-btn {
    background: none;
    border: none;
    color: #c77dff;
    font-size: 1.7em;
    cursor: pointer;
    margin-right: 4px;
    transition: color 0.2s;
}
#audio-toggle-btn:active {
    color: #23ff97;
}
.hidden {display:none;}

#banner-section img, #media-section img, #media-section video {
    width: 100%;
    max-height: 320px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: transform 0.2s;
}
#banner-section img:hover, #media-section img:hover, #media-section video:hover {
    transform: scale(1.01);
}
#media-section {
    margin-bottom: 8px;
}
#games-section {
    margin-top: 10px;
    margin-bottom: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 13px;
}
.game-box {
    background: #220035e0;
    border-radius: 13px;
    padding: 8px 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 190px;
    box-shadow: 0 2px 10px #0002;
}
.game-box img {
    width: 36px; height: 36px; border-radius:50%;
    object-fit:cover; background:#fff;
    border:2px solid #c77dff;
}
.game-box .vs {font-weight:700;color:#b4a7cf;font-size:1em;margin:0 8px;}
.game-box .team-name {font-weight:600;}
.game-box .game-time {color:#ffe7bb;font-size:0.89em;}
.game-box .open-link {
    background: #4e0080cc;
    border: none; border-radius: 7px;
    color: #ffe7bb; font-size: 0.96em;
    cursor: pointer; padding: 2px 11px;
    margin-left: 9px; transition: background 0.2s;
}
.game-box .open-link:hover {background: #23ff97;color:#320042;}
/* ğŸ’¥âœ”ï¸Site 1 ya kare daga nan âœ”ï¸ */

/* ğŸ’¥âœ”ï¸Site 2 ya fara daga nan, âœ”ï¸ */
#footer-comment {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100vw;
    background: linear-gradient(to top, #220035dd 80%, #4e0080cc 100%);
    box-shadow: 0 -2px 16px rgba(28,0,40,0.19);
    padding: 10px 0 14px 0;
    z-index: 100;
}
#comment-container {
    max-width: 700px;
    margin: 0 auto;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding: 0 10px;
}
#upload-btn {
    background: none;
    border: none;
    color: #b4a7cf;
    font-size: 1.5em;
    cursor: pointer;
    margin-bottom: 8px;
    transition: color 0.2s;
}
#upload-btn:hover {
    color: #ffe7bb;
}
#comment-input {
    flex: 1;
    min-height: 36px;
    max-height: 110px;
    border: none;
    border-radius: 12px;
    background: #2e0040;
    color: #fff;
    font-size: 1em;
    padding: 7px 14px;
    resize: none;
    outline: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    transition: background 0.2s, box-shadow 0.2s;
}
#comment-input:focus {
    background: #380061;
    box-shadow: 0 4px 14px rgba(0,0,0,0.13);
}
#send-btn {
    background: none;
    border: none;
    color: #c77dff;
    font-size: 1.47em;
    cursor: pointer;
    margin-bottom: 8px;
    transition: color 0.2s;
    animation: send-bounce 0.9s infinite;
}
#send-btn:disabled {
    color: #7b6b9b;
    animation: none;
}
@keyframes send-bounce {
    0%   {transform: translateY(0);}
    50%  {transform: translateY(-3px);}
    100% {transform: translateY(0);}
}
/* ğŸ’¥âœ”ï¸Site 2 ya kare daga nan âœ”ï¸ */


/* ğŸ”±âœ”ï¸Site 3 ya fara daga nan âœ”ï¸ */
/* Comments Section */
#comments-section {
    margin-top: 10px;
    padding-bottom: 80px;
}


.comment { 
    border-radius: 0px;
    margin-bottom: 20px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: box-shadow 0.2s;
    border-left: 4px solid rgba(199, 125, 255, 0.3);
        
}


.comment:hover {
    background: rgba(40, 0, 60, 0.2);
    box-shadow: 0 0 8px rgba(199, 125, 255, 0.2);
}

.comment.user-owned {
    border-left: 3px solid #4dffea;
    background: rgba(40,0,80,0.15);
}

.comment .comment-header {
    display: flex;
    align-items: center;
    gap: 1px;
    margin-bottom: 6px;
    position: relative;
}

.comment .avatar {
    width: 45px; 
    height: 45px; 
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #c77dff;
    cursor: pointer;
    background: #fff;
    z-index: 1;
}

.comment .team-icon {
    width: 28px; 
    height: 28px; 
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ffecb3;
    background: #fff;
    position: absolute;
    top: -10px; 
    left: 37px; 
    z-index: 2;
}

.comment .user-info {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    position: relative;
    top: -5px;
}

.comment .full-name {
    font-weight: 600;
    font-size: 1.07em;
    color: #ffe7bb;
    max-width: 150px; 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.comment .comment-time {
    font-size: 0.6em;
    color: #c7bfff;
    position: absolute;
    right: 0;
    top: 5%;
    transform: translateY(-50%);
}

.comment .comment-body {
    margin-bottom: 1px;
    margin-left: 1px;
    font-size: 1em;
    color: #fff;
    word-break: break-word;
}

.comment .comment-media {
    margin: 2px 0 2px 50px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.comment .comment-media img,
.comment .comment-media video {
    max-width: 210px;
    max-height: 170px;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.14);
}


.comment .comment-actions .action-btn {
    background: none;
    border: none;
    color: #9f9cff;
    font-size: 1.19em;
    cursor: pointer;
    margin-right: 4px;
    transition: color 0.2s;
    border-bottom: 0.60px solid #4dffea;
}

.comment .comment-actions .action-btn.liked {
    color: #1effc1;
}

.comment .comment-actions .action-btn.seen {
    color: #ffe5a2;
}

.comment .comment-actions .action-btn.emoji {
    font-size: 1.22em;
}

.comment .comment-actions .emoji-list {
    display: flex;
    gap: 5px;
    margin-right: 7px;
    
    
}


.comment .emoji-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    top: -18px; 
    right: 15px; 
    gap: 5px;
}

.comment .emoji-container span {
    font-size: 1.3em;
    cursor: pointer;
    transition: transform 0.2s;
}

.comment .emoji-container span:hover {
    transform: scale(1.2);
}


.comment .reply-btn:hover {
    background: #33144c;
}

.comment .edit-delete-actions {
    display: flex;
    gap: 7px;
    margin-left: auto;
    margin-right: 10px;
    position: absolute;
    top: 8px;
    right: 0;
}

.comment .edit-delete-actions button {
    background: none;
    border: none;
    color: #ffe7bb;
    cursor: pointer;
    font-size: 1em;
    padding: 3px 7px;
    border-radius: 7px;
    transition: background 0.2s;
}

.comment .edit-delete-actions button:hover {
    background: #5c227c;
}



.replies {
    margin-left: 5px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.reply {
    background: rgba(80,0,120,0.1);
    border-radius: 10px;
    padding: 9px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: box-shadow 0.2s;
    border-left: 3px solid rgba(255, 236, 179, 0.3);
    margin-left: 20px; 
}

.reply:hover {
    background: rgba(80, 0, 120, 0.2);
    box-shadow: 0 0 8px rgba(255, 236, 179, 0.2);
}

.reply.user-owned {
    border-left: 1px solid #4dffea;
    background: rgba(80,0,160,0.15);
}

.reply .reply-by {
    font-size: 0.85em;
    color: #c9c7ff;
    margin-bottom: 5px;
}

.reply .reply-by span {
    color: #ffe7bb;
    font-weight: 600;
}

.reply .reply-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    position: relative;
}
.reply .avatar {
    width: 38px; 
    height: 38px; 
    border-radius: 50%;
    object-fit: cover;
    background: #fff;
    border: 2px solid #c77dff;
    z-index: 1;
}

.reply .team-icon {
    width: 22px;
    height: 22px; 
    border-radius: 50%;
    object-fit: cover;
    background: #fff;
    border: 1px solid #ffecb3;
    position: absolute;
    top: -15px;
    left: 24px; 
    z-index: 2;
}


.reply .reply-media img,
.reply .reply-media video {
    max-width: 170px;
    max-height: 140px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.09);
}


.reply .reply-actions .action-btn {
    background: none;
    border: none;
    color: #ac9cff;
    font-size: 1.09em;
    cursor: pointer;
    margin-right: 3px;
    transition: color 0.2s;
    border-bottom: 0.80px solid #4dffea;
}


.reply .reply-actions .action-btn.liked {
    color: #1effc1;
}

.reply .reply-actions .action-btn.seen {
    color: #ffe5a2;
}

.reply .reply-actions .action-btn.emoji {
    font-size: 1.14em;
}

.reply .reply-actions .emoji-list {
    display: flex;
    gap: 4px;
    margin-right: 5px;
}


.reply .emoji-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    top: -15px;
    right: 15px; 
    gap: 4px;
}

.reply .emoji-container span {
    font-size: 1.2em;
    cursor: pointer;
    transition: transform 0.2s;
}

.reply .emoji-container span:hover {
    transform: scale(1.2);
}

.reply .edit-delete-actions {
    display: flex;
    gap: 6px;
    margin-left: auto;
    margin-right: 7px;
    position: absolute;
    top: 5px;
    right: 0;
}

.reply .edit-delete-actions button {
    background: none;
    border: none;
    color: #ffe7bb;
    cursor: pointer;
    font-size: 0.98em;
    padding: 2px 6px;
    border-radius: 7px;
    transition: background 0.2s;
}

.reply .edit-delete-actions button:hover {
    background: #5c227c;
}


.comment .comment-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    position: relative; 
}

.comment .comment-time {
    font-size: 0.82em;
    color: #c7bfff;
    margin-left: auto; 
}


.comment .edit-delete-actions {
    display: flex;
    gap: 7px;
    margin-left: auto;
}


.reply .reply-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    position: relative;
}


.reply .reply-time {
    font-size: 0.7em;
    color: #b7bfff;
    margin-left: auto;
}


.reply .edit-delete-actions {
    display: flex;
    gap: 6px;
    margin-left: auto;
}


.score-prediction {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-left: 50px;
    margin-bottom: 10px;
    font-weight: 600;
    color: #ffe7bb;
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(0,0,0,0.1);
}

.score-prediction .score-team-logo {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.3);
}

.score-prediction .score-team-name {
    font-size: 0.9em;
    white-space: nowrap;
}

.score-prediction .score-value {
    font-size: 1.1em;
    color: #91fff2;
}


#emoji-container {
    position: fixed; 
    background-color: #33004a;
    border: 1px solid #c77dff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    padding: 10px;
    display: none; 
    z-index: 10000; 
    flex-wrap: wrap;
    gap: 8px; 
    max-width: 300px; 
}

#emoji-container .emoji-icon {
    cursor: pointer;
    font-size: 24px;
    padding: 6px;
    border-radius: 5px;
    transition: background-color 0.2s, transform 0.2s;
    color: #ffffff; 
    background-color: rgba(255,255,255,0.05); 
}

#emoji-container .emoji-icon:hover {
    background-color: rgba(255,255,255,0.15); 
    transform: scale(1.1);
}


#emoji-container .close-emoji-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 18px;
    color: #ff4c7d;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
}

#emoji-container .close-emoji-btn:hover {
    transform: scale(1.2);
}



.comment-media video.comment-video,
.reply-media video.reply-video {
    max-width: 100%; 
    height: auto; 
    display: block; 
    border-radius: 8px; 
    margin-top: 10px; 
    object-fit: contain; 
    border: 1px solid rgba(255,255,255,0.1); 
}


.comment-actions, .reply-actions {
    display: flex;
    flex-wrap: wrap; 
    align-items: center;
    gap: 10px; 
    margin-top: 10px;
}

.action-btn {
    background-color: #4a0072; 
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 20px; 
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s ease, transform 0.2s ease;
    display: flex; 
    align-items: center;
    gap: 5px; 
}

.action-btn:hover {
    background-color: #6a0096; 
    transform: translateY(-2px); 
}


#custom-input-modal {
    background-color: #220035e0; 
    color: #fff;
    padding: 22px 36px;
    border-radius: 14px;
    box-shadow: 0 2px 40px rgba(0,0,0,0.33);
    font-size: 1.15em;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

#custom-input-modal h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #ffe7bb;
}

#custom-input-modal span {
    display: block;
    margin-bottom: 10px;
}

#custom-input-field {
    width: calc(100% - 20px); 
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #5d257a;
    background-color: #2e0040;
    color: #fff;
    font-size: 1em;
    outline: none;
}

#custom-input-field:focus {
    border-color: #c77dff;
    box-shadow: 0 0 8px rgba(199, 125, 255, 0.5);
}

#modal-viewer .close-btn {
    position: absolute;
    top: 10px;
    right: 16px;
    color: #ffe7bb;
    font-size: 2.1em;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: color 0.2s;
}

#modal-viewer .close-btn:hover {
    color: #ff4c7d;
}

#notification-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); 
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
}

#notification-container.show {
    opacity: 1;
    pointer-events: auto;
}

.notification-box {  
    position: relative;
}

.confirmation-box {
   
}

.confirm-buttons {
    
}

.reply .reply-main-info .reply-by-user-name {
    font-size: 0.85em;
    color: #c9c7ff; 
    margin-left: 5px; 
    font-weight: normal; 
   
}


.edit-delete-actions {
    display: none; 
    gap: 8px;
    margin-top: 10px;
}

.edit-delete-actions.show-actions {
    display: flex; 
}

.edit-delete-actions button {
    background-color: #555;
    color: #fff;
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em;
    transition: background-color 0.2s ease;
}

.edit-delete-actions .edit-btn:hover {
    background-color: #007bff; 
}

/* ğŸ”±âœ”ï¸Site 3 ya kare daga nan, âœ”ï¸ */

#main-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 2px 10px 8px 18px;
    
}

.comment-learnmore {
    color: #4dffea; 
    font-weight: 700;
    cursor: pointer;
    font-size: 0.95em;
    text-decoration: underline;
    margin-left: 0.3em;
    white-space: nowrap; 
}


.comment-body,
.reply-body {
    overflow: visible !important; 
    display: block !important; 
    -webkit-line-clamp: unset !important; 
    -webkit-box-orient: unset !important;
}
    </style>
    
</head>
<body>
    <!-- ğŸ’¥âœ”ï¸Site 1, ya fara daga nan, âœ”ï¸ -->
    <header id="header-bar">
        <img src="https://i.imgur.com/CgvdgMA.png" id="logo-img" alt="Logo" />
        <button id="audio-toggle-btn" class="hidden" title="Kunne/Kashe Rediyo"><i class="fas fa-pause"></i></button>
    </header>
    <div id="main-container">
        <div id="banner-section"></div>
        <div id="media-section"></div>
        <div id="post-text"></div>
        <div id="audio-section"></div>
        <div id="games-section"></div>
        <div id="post-meta"></div>
    </div>
    <!-- ğŸ’¥âœ”ï¸Site 1 ya kare daga nan âœ”ï¸ -->
    
    
 

    <!-- ğŸ’¥âœ”ï¸Site 2 ya fara daga nan, âœ”ï¸ -->
    <footer id="footer-comment">
        <div id="comment-container">
            <button id="upload-btn" title="Upload Media"><i class="fas fa-plus"></i></button>
            <textarea id="comment-input" placeholder="Rubuta text..."></textarea>
            <button id="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
        </div>
        <input type="file" id="file-upload" accept="image/*,video/*" multiple style="display:none;">
    </footer>
    <!-- ğŸ’¥âœ”ï¸Site 2 ya kare daga nan âœ”ï¸ -->

    <!-- ğŸ”±âœ”ï¸Site 3 ya fara daga nan âœ”ï¸ -->
    <div id="comments-section"></div>
    
    <div id="modal-profile" class="hidden"></div>
    
    <div id="emoji-container">    
</div>

<div id="notification-container">    
</div>


<div id="modal-viewer" class="hidden">   
</div>

    <!-- ğŸ”±âœ”ï¸Site 3 ya kare daga nan, âœ”ï¸ -->

    <script type="module">

Â  import { app, analytics, firebaseConfig } from './firebase.js';

Â  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

Â  import { getDatabase, ref, get, set, push, update, remove, child, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
Â  const db = getDatabase();

Â  const auth = getAuth();

Â  let currentUser = null;

Â Â Â  

Â  let kaiTsayePostIdForComments = null; 

Â  let postData = null;

Â  let commentsCache = {};

Â  let replyingToOriginalCommentId = null;

Â  let replyingToParentReplyId = null;

 

const MAX_TEXT_LENGTH_PREVIEW = 300; 

const MAX_COMMENT_TEXT_LENGTH = 250; 

const SEEN_POSTS_DAILY_KEY = "tauraronwasa_seen_posts_daily";
 
Â  // ğŸ’¥âœ”ï¸Site 1, ya fara daga nan, âœ”ï¸
Â  onAuthStateChanged(auth, user => {

Â Â Â  if (user) {

Â Â Â Â Â  currentUser = user;

Â Â Â Â Â  loadPostData(); 

Â Â Â Â  

Â Â Â  } else {

Â Â Â Â Â  window.showNotification("Da fatan za a shiga asusunka don ganin wannan shafi ko yin sabon register.");

Â Â Â  }

Â  });
Â  function loadPostData() {

 

Â Â Â  const mainKaiTsayePostRef = ref(db, "KaiTsayePost");

Â Â Â  get(mainKaiTsayePostRef).then(snapshot => {

Â Â Â Â Â  if (snapshot.exists()) {

Â Â Â Â Â Â Â  postData = snapshot.val();

Â Â Â  

Â Â Â Â Â Â Â  kaiTsayePostIdForComments = postData.postid || urlParams.get('postId') || localStorage.getItem('currentKaiTsayePostId');
Â Â Â Â Â Â Â  if (!kaiTsayePostIdForComments) {

Â Â Â Â Â Â Â Â Â Â Â  window.showNotification("Ba a samu ID na comments ba a cikin post É—in KaiTsayePost.");

Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('post-text').textContent = "Ba a samu post ba, ko kuma ba a tantance ID na comments ba.";

Â Â Â Â Â Â Â Â Â Â Â  return;

Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  localStorage.setItem('currentKaiTsayePostId', kaiTsayePostIdForComments); 
Â Â Â Â Â Â Â  renderPost(postData);

Â Â Â Â Â Â Â  localStorage.setItem(`KaiTsayePost_data`, JSON.stringify(postData)); 

Â Â Â Â Â Â Â  listenCommentsRealtime(); 

Â Â Â Â Â  } else {

Â Â Â Â Â Â Â  const postTextElement = document.getElementById('post-text');

Â Â Â Â Â Â Â  if (postTextElement) {

Â Â Â Â Â Â Â Â Â  postTextElement.textContent = "Ba a samu post ba.";

Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  window.showNotification("TauraronWasa Ba Su Kai Tsaye'.");

Â Â Â Â Â  }

Â Â Â  }).catch(error => {

Â Â Â Â Â Â Â  console.error("Error loading KaiTsayePost data:", error);

Â Â Â Â Â Â Â  window.showNotification("An sami kuskure ku sake gwadawa.");

Â Â Â Â Â Â Â  document.getElementById('post-text').textContent = "An sami kuskure wajen ku sake gwadawa.";

Â Â Â  });

Â  }
Â  function renderPost(data) {

Â Â Â  const banner = document.getElementById('banner-section');

Â Â Â  if (banner) {

Â Â Â Â Â  banner.innerHTML = data.photoLink ? `<img src="${data.photoLink}" alt="Banner" onerror="this.style.display='none'" />` : '';

Â Â Â Â Â  if (data.photoLink) banner.querySelector('img').onclick = () => window.showImageViewer(data.photoLink);

Â Â Â  }
Â Â Â  const media = document.getElementById('media-section');

Â Â Â  if (media) {

Â Â Â Â Â  media.innerHTML = '';

Â Â Â Â Â  if (data.videoLink) {

Â Â Â Â Â Â Â  media.innerHTML = `<video src="${data.videoLink}" controls onerror="this.style.display='none'"></video>`;

Â Â Â Â Â Â Â  media.querySelector('video').onclick = () => window.showVideoViewer(data.videoLink);

Â Â Â Â Â  }

Â Â Â  }
Â Â Â  const postTextElement = document.getElementById('post-text');

Â Â Â  if (postTextElement) {

Â Â Â Â Â  postTextElement.innerHTML = data.text ? `<div>${data.text}</div>` : '';

Â Â Â  }
Â Â Â  const audioSection = document.getElementById('audio-section');

Â Â Â  if (audioSection) {

Â Â Â Â 
Â Â Â Â Â  audioSection.innerHTML = '';
Â Â Â Â Â  let audioLink = data.audioPostLink || data.audiolink || data.rediyoKaiTsayeAudioLink;

Â Â Â Â Â  if (audioLink && !data.rediyoKaiTsayeAudioLink) {
Â Â Â Â Â Â Â  audioSection.innerHTML = `<audio src="${audioLink}" controls id="audio-player"></audio>`;
Â Â Â Â Â  }

Â Â Â Â Â  
Â Â Â Â Â  if (audioLink) {
Â Â Â Â Â Â Â  setupAudioToggle(audioLink);
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  const toggleBtn = document.getElementById('audio-toggle-btn');
Â Â Â Â Â Â Â  if (toggleBtn) {
Â Â Â Â Â Â Â Â Â  toggleBtn.classList.add('hidden');
Â Â Â Â Â Â Â  }
Â Â Â Â Â  }

Â Â Â  }
Â Â Â  const gamesDiv = document.getElementById('games-section');

Â Â Â  if (gamesDiv) {

Â Â Â Â Â  gamesDiv.innerHTML = '';

Â Â Â Â Â  for (let i = 1; i <= 6; i += 2) {

Â Â Â Â Â Â Â  let logo1 = data[`onlineLink1LogoLink${i}`];

Â Â Â Â Â Â Â  let logo2 = data[`onlineLink1LogoLink${i+1}`];

Â Â Â Â Â Â Â  let team1 = data[`sunanKungiya${i}`];

Â Â Â Â Â Â Â  let team2 = data[`sunanKungiya${i+1}`];

Â Â Â Â Â Â Â  let time1 = data[`timeDaZaaFaraWasa${i}`];

Â Â Â Â Â Â Â  let online1 = data[`onlineLink${i}`];

Â Â Â Â Â Â Â  let online2 = data[`onlineLink${i+1}`];

Â Â Â Â Â Â Â  if (logo1 && logo2 && team1 && team2) {

Â Â Â Â Â Â Â Â Â  gamesDiv.innerHTML += `

Â Â Â Â Â Â Â Â Â Â Â  <div class="game-box">

Â Â Â Â Â Â Â Â Â Â Â Â Â  <img src="${logo1}" onerror="this.src='https://placehold.co/50x50/e0e0e0/000000?text=Logo'" /><span class="team-name">${team1}</span>

Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="vs">VS</span>

Â Â Â Â Â Â Â Â Â Â Â Â Â  <img src="${logo2}" onerror="this.src='https://placehold.co/50x50/e0e0e0/000000?text=Logo'" /><span class="team-name">${team2}</span>

Â Â Â Â Â Â Â Â Â Â Â Â Â  <p class="game-time">${time1 ? formatTime(time1) : ''}</p>

Â Â Â Â Â Â Â Â Â Â Â Â Â  ${(online1 ? `<button class="open-link" onclick="window.open('${online1}','_blank')">Click</button>` : '')}

Â Â Â Â Â Â Â Â Â Â Â Â Â  ${(online2 ? `<button class="open-link" onclick="window.open('${online2}','_blank')">Click</button>` : '')}

Â Â Â Â Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â Â Â Â Â  `;

Â Â Â Â Â Â Â  }

Â Â Â Â Â  }

Â Â Â  }
Â Â Â  const postMetaElement = document.getElementById('post-meta');

Â Â Â  if (postMetaElement) {

Â Â Â Â 

Â Â Â Â Â  const totalComments = data.totalComment || 0;

Â Â Â Â Â  postMetaElement.innerHTML = `

Â Â Â Â Â Â Â  <span>${data.posttime ? formatTime(data.posttime) : ''}</span>

Â Â Â Â Â Â  

Â Â Â Â Â Â  `;
Â Â Â Â Â  const shereBtn = document.getElementById('shere-btn');

Â Â Â Â Â  if (shereBtn) {

Â Â Â Â Â Â Â  shereBtn.onclick = async () => {

Â Â Â Â Â Â Â Â Â  const shareUrl = `${window.location.origin}${window.location.pathname}?postId=${kaiTsayePostIdForComments}`; 

Â Â Â Â Â Â Â Â Â  const shareTitle = data.text ? data.text.substring(0, 50) + '...' : 'Sabon Post daga KaiTsayePost';
Â Â Â Â Â Â Â Â Â  if (navigator.share) {

Â Â Â Â Â Â Â Â Â Â Â  try {

Â Â Â Â Â Â Â Â Â Â Â Â Â  await navigator.share({

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  title: shareTitle,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  url: shareUrl

Â Â Â Â Â Â Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â Â Â Â Â Â Â  window.showNotification("An raba post É—in!");

Â Â Â Â Â Â Â Â Â Â Â  } catch (error) {

Â Â Â Â Â Â Â Â Â Â Â Â Â  if (error.name === 'AbortError') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log('Share was cancelled by the user.');

Â Â Â Â Â Â Â Â Â Â Â Â Â  } else {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error('Error sharing:', error);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  window.showNotification("An kasa raba post É—in. Da fatan za a sake gwadawa.");

Â Â Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â  } else {

Â Â Â Â Â Â Â Â Â Â Â  if (navigator.clipboard) {

Â Â Â Â Â Â Â Â Â Â Â Â Â  try {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await navigator.clipboard.writeText(shareUrl);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  window.showNotification("Link É—in an kwafe shi!");

Â Â Â Â Â Â Â Â Â Â Â Â Â  } catch (err) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error('Failed to copy text: ', err);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  window.showNotification("An kasa kwafa link É—in.");

Â Â Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â  } else {

Â Â Â Â Â Â Â Â Â Â Â Â Â  const textArea = document.createElement("textarea");

Â Â Â Â Â Â Â Â Â Â Â Â Â  textArea.value = shareUrl;

Â Â Â Â Â Â Â Â Â Â Â Â Â  document.body.appendChild(textArea);

Â Â Â Â Â Â Â Â Â Â Â Â Â  textArea.focus();

Â Â Â Â Â Â Â Â Â Â Â Â Â  textArea.select();

Â Â Â Â Â Â Â Â Â Â Â Â Â  try {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  document.execCommand('copy');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  window.showNotification("Link É—in an kwafe shi!");

Â Â Â Â Â Â Â Â Â Â Â Â Â  } catch (err) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error('Fallback: Oops, unable to copy', err);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  window.showNotification("An kasa kwafa link É—in.");

Â Â Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â Â Â  document.body.removeChild(textArea);

Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  };

Â Â Â Â Â  }

Â Â Â  }

Â  }
Â  
Â  function setupAudioToggle(audioLink) {

Â Â Â  const toggleBtn = document.getElementById('audio-toggle-btn');

Â Â Â  if (toggleBtn) {
Â Â Â Â Â  toggleBtn.classList.remove('hidden');

Â Â Â Â Â  
Â Â Â Â Â  let audioPlayer = document.getElementById('audio-player-global');
Â Â Â Â Â  if (!audioPlayer) {
Â Â Â Â Â Â Â  audioPlayer = new Audio(audioLink);
Â Â Â Â Â Â Â  audioPlayer.id = 'audio-player-global';
Â Â Â Â Â Â Â  document.body.appendChild(audioPlayer);
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  audioPlayer.src = audioLink;
Â Â Â Â Â  }
Â Â Â Â Â  
Â Â Â Â 
Â Â Â Â Â  if (postData && postData.rediyoKaiTsayeAudioLink) {
Â Â Â Â Â Â Â  audioPlayer.play().catch(e => {
Â Â Â Â Â Â Â Â Â  console.warn("Autoplay ya gaza, user zai danna button don kunna rediyo.", e);
Â Â Â Â Â Â Â Â Â  toggleBtn.innerHTML = `<i class="fas fa-play"></i>`;
Â Â Â Â Â Â Â  });
Â Â Â Â Â  }


Â Â Â Â Â  
Â Â Â Â Â  toggleBtn.onclick = () => {
Â Â Â Â Â Â Â  if (!audioPlayer.paused) {
Â Â Â Â Â Â Â Â Â  audioPlayer.pause();
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â  audioPlayer.play();
Â Â Â Â Â Â Â  }
Â Â Â Â Â  };
Â Â Â Â Â  
Â Â Â Â 
Â Â Â Â Â  audioPlayer.onplay = () => toggleBtn.innerHTML = `<i class="fas fa-pause"></i>`;
Â Â Â Â Â  audioPlayer.onpause = () => toggleBtn.innerHTML = `<i class="fas fa-play"></i>`;

Â Â Â  }

Â  }
Â  const commentInput = document.getElementById('comment-input');

Â  const uploadBtn = document.getElementById('upload-btn');

Â  const sendBtn = document.getElementById('send-btn');

Â  const fileUpload = document.getElementById('file-upload');

Â  let selectedFiles = [];
Â  if (uploadBtn) uploadBtn.addEventListener('click', () => fileUpload.click());

Â  if (fileUpload) fileUpload.addEventListener('change', e => {

Â Â Â  selectedFiles = Array.from(e.target.files).slice(0, 3);

Â Â Â  if (sendBtn) sendBtn.disabled = !commentInput.value.trim() && selectedFiles.length === 0;

Â  });

Â  if (commentInput) commentInput.addEventListener('input', () => {

Â Â Â  commentInput.style.height = '36px';

Â Â Â  commentInput.style.height = Math.min(commentInput.scrollHeight, 110) + 'px';

Â Â Â  if (sendBtn) sendBtn.disabled = !commentInput.value.trim() && selectedFiles.length === 0;

Â  });

Â  if (sendBtn) sendBtn.addEventListener('click', handleSendComment);
Â 

Â  async function fetchWithRetry(url, options, retries = 3, delay = 1000) {

Â Â Â  for (let i = 0; i < retries; i++) {

Â Â Â Â Â  try {

Â Â Â Â Â Â Â  const response = await fetch(url, options);

Â Â Â Â Â Â Â  if (!response.ok) {

Â Â Â Â Â Â Â Â Â  if (response.status >= 500 || !response.status) {

Â Â Â Â Â Â Â Â Â Â Â  throw new Error(`Server error or network issue: ${response.status || 'No Status'}`);

Â Â Â Â Â Â Â Â Â  } else {

Â Â Â Â Â Â Â Â Â Â Â  console.warn(`Client error, no retry: ${response.status} - ${await response.text()}`);

Â Â Â Â Â Â Â Â Â Â Â  return null;

Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  return response;

Â Â Â Â Â  } catch (error) {

Â Â Â Â Â Â Â  console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying...`);

Â Â Â Â Â Â Â  if (i < retries - 1) {

Â Â Â Â Â Â Â Â Â  await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));

Â Â Â Â Â Â Â  }

Â Â Â  }

Â Â Â  console.error(`All ${retries} fetch retries failed for ${url}.`);

Â Â Â  return null;

Â  }
Â  

Â  async function sendUserNotification(recipientUid, senderData, replyTextSnippet, originalCommentId, parentReplyId) {

Â Â Â  try {

Â Â Â Â Â  const recipientUserRef = ref(db, `users/${recipientUid}`);

Â Â Â Â Â  const recipientSnapshot = await get(recipientUserRef);

Â Â Â Â Â  const recipientData = recipientSnapshot.exists() ? recipientSnapshot.val() : null;
Â Â Â Â Â  if (!recipientData || !recipientData.subscription || !recipientData.userIpAddress) {

Â Â Â Â Â Â Â  console.warn(`Recipient ${recipientUid} does not have complete notification data (subscription, IP, or full name).`);

Â Â Â Â Â Â Â  return;

Â Â Â Â Â  }
Â Â Â Â Â  const payload = {

Â Â Â Â Â Â Â  recipientSubscription: recipientData.subscription,

Â Â Â Â Â Â Â  recipientFullName: recipientData.fullName || 'Unknown User',

Â Â Â Â Â Â Â  recipientIpAddress: recipientData.userIpAddress,

Â Â Â Â Â Â Â  title: `Sabon Reply Daga ${senderData.fullName}`,

Â Â Â Â Â Â Â  body: replyTextSnippet.substring(0, 100) + (replyTextSnippet.length > 100 ? '...' : ''),

Â Â Â Â Â Â Â  icon: senderData.profileLogo,

Â Â Â Â Â Â Â  badge: postData.userTeamLogo || 'https://i.imgur.com/CgvdgMA.png', // Assuming postData.userTeamLogo for sender's team

Â Â Â Â Â Â Â  url: `${window.location.origin}${window.location.pathname}?postId=${kaiTsayePostIdForComments}#comment-${originalCommentId}`,

Â Â Â Â Â  };
Â Â Â Â Â  if (parentReplyId) {

Â Â Â Â Â Â Â  payload.body = `Reply ga Reply: ${replyTextSnippet.substring(0, 100)}${(replyTextSnippet.length > 100 ? '...' : '')}`;

Â Â Â Â Â  }
Â Â Â Â Â  console.log("Sending notification payload:", payload);
Â Â Â Â Â  const response = await fetchWithRetry('https://tauraronwasa.pages.dev/api/userNotification', {

Â Â Â Â Â Â Â  method: 'POST',

Â Â Â Â Â Â Â  headers: {

Â Â Â Â Â Â Â Â Â  'Content-Type': 'application/json',

Â Â Â Â Â Â Â  },

Â Â Â Â Â Â Â  body: JSON.stringify(payload)

Â Â Â Â Â  });
Â Â Â Â Â  if (response && response.ok) {

Â Â Â Â Â Â Â  console.log("Notification sent successfully to worker.");

Â Â Â Â Â  } else {

Â Â Â Â Â Â Â  console.warn("Failed to send notification to worker.");

Â Â Â Â Â  }
Â Â Â  } catch (error) {

Â Â Â Â Â  console.error("Error in sendUserNotification:", error);

Â Â Â  }

Â  }
}


  async function handleSendComment() {
    if (!currentUser || !kaiTsayePostIdForComments) return; 
    if (sendBtn) sendBtn.disabled = true;

    let commentMediaLinks = {
      images: [],
      video: null
    };
    let commentText = commentInput ? commentInput.value.trim() : '';

    if (!commentText && selectedFiles.length === 0) {
      if (sendBtn) sendBtn.disabled = false;
      return;
    }

    if (selectedFiles.length > 0) {
      for (const file of selectedFiles) {
        const formData = new FormData();
        formData.append("image", file);

        try {
          const response = await fetch("https://api.imgur.com/3/image", {
            method: "POST",
            headers: {
              Authorization: "Client-ID 5acf7eff9c91660"
            },
            body: formData
          });
          const data = await response.json();
          if (data.success && data.data && data.data.link) {
            if (file.type.startsWith("image/")) {
              commentMediaLinks.images.push(data.data.link);
            } else if (file.type.startsWith("video/")) {
              commentMediaLinks.video = data.data.link;
            }
          } else {
            console.error("Imgur upload failed for file:", file.name, data);
            window.showNotification(`An kasa loda hoton/bidiyon '${file.name}'.`);
          }
        } catch (uploadError) {
          console.error("Error uploading to Imgur:", uploadError);
          window.showNotification(`An sami kuskure wajen loda hoton/bidiyon '${file.name}'.`);
        }
      }
    }

    try {
      const commentsRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment`);

      let recipientUidForNotification = null;

      if (replyingToOriginalCommentId) {
        const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);

        if (originalComment) {
          if (replyingToParentReplyId) {
            if (originalComment.replies) {
              const parentReply = Object.values(originalComment.replies).find(r => r.id === replyingToParentReplyId);
              if (parentReply) {
                recipientUidForNotification = parentReply.userId;
              }
            }
          } else {
            recipientUidForNotification = originalComment.userId;
          }
        }

        let replyObj = {
          userId: currentUser.uid,
          avatarUrl: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
          supportTeams: postData.userTeamLogo || '', 
          fullName: currentUser.displayName || 'Unknown User',
          commentText: commentText,
          imageLink1: commentMediaLinks.images[0] || '',
          imageLink2: commentMediaLinks.images[1] || '',
          imageLink3: commentMediaLinks.images[2] || '',
          videoComment: commentMediaLinks.video || '',
          replyTime: new Date().toISOString(),
          replyLike: 0,
          userFirebaseUid: currentUser.uid,
          replyingToCommentId: replyingToOriginalCommentId,
          replyingToReplyId: replyingToParentReplyId,
        };

        if (replyingToParentReplyId) {
          const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);
          if (originalComment && originalComment.replies) {
            const parentReply = Object.values(originalComment.replies).find(r => r.id === replyingToParentReplyId);
            if (parentReply) {
              replyObj.replyingToReplyUserFullName = parentReply.fullName;
            }
          }
        } else {
          const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);
          if (originalComment) {
            replyObj.replyingToReplyUserFullName = originalComment.fullName;
          }
        }

        const repliesRef = child(commentsRef, `${replyingToOriginalCommentId}/replies`);
        const newReplyRef = push(repliesRef);
        await set(newReplyRef, replyObj);
       

        if (recipientUidForNotification && recipientUidForNotification !== currentUser.uid) {
          const senderData = {
            fullName: currentUser.displayName || 'Unknown User',
            profileLogo: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
            teamLogo: postData.userTeamLogo || 'https://i.imgur.com/CgvdgMA.png',
          };
          await sendUserNotification(recipientUidForNotification, senderData, commentText, replyingToOriginalCommentId, replyingToParentReplyId);
        }

      } else {
        const commentObj = {
          userId: currentUser.uid,
          avatarUrl: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
          supportTeams: postData.userTeamLogo || '',
          fullName: currentUser.displayName || 'Unknown User',
          commentText: commentText,
          imageLink1: commentMediaLinks.images[0] || '',
          imageLink2: commentMediaLinks.images[1] || '',
          imageLink3: commentMediaLinks.images[2] || '',
          videoComment: commentMediaLinks.video || '',
          commentTime: new Date().toISOString(),
          commentLike: 0,
          commentEmoji: '',
          replies: {},
          userFirebaseUid: currentUser.uid,
        };
        const newCommentRef = push(commentsRef);
        await set(newCommentRef, commentObj);
        
      }

      
      const totalCommentRef = ref(db, `KaiTsayePost/totalComment`);
      await runTransaction(totalCommentRef, (currentValue) => {
          return (currentValue || 0) + 1;
      });

    } catch (err) {
      console.warn("", err);
     
    }

    if (commentInput) {
      commentInput.value = '';
      commentInput.style.height = '36px';
      commentInput.placeholder = "Rubuta commentâ€¦";
    }
    replyingToOriginalCommentId = null;
    replyingToParentReplyId = null;
    selectedFiles = [];
    if (fileUpload) fileUpload.value = '';
    if (sendBtn) sendBtn.disabled = false;
  }

  function listenCommentsRealtime() {
    if (!kaiTsayePostIdForComments) {
        console.warn("kaiTsayePostIdForComments not set, cannot listen for comments.");
        return;
    }
    const commentsRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment`); 
    onValue(commentsRef, snapshot => {
      let comments = [];
      snapshot.forEach(childSnap => {
        let comment = childSnap.val();
        comment.id = childSnap.key;
        comments.unshift(comment);
      });
      commentsCache = comments;
      renderComments(comments);
    });
  }

  function renderComments(comments) {
    const section = document.getElementById('comments-section');
    if (!section) return;
    section.innerHTML = '';
    comments.forEach(comment => {
      section.append(renderComment(comment));
    });
  }

  function renderComment(comment) {
    const div = document.createElement('div');
    div.className = `comment ${comment.userId === currentUser.uid ? 'user-owned' : ''}`;
    div.dataset.commentId = comment.id;
    

    let commentBodyText = comment.commentText || '';
    let displayCommentText = commentBodyText;
    let hasMoreCommentText = false;

    if (commentBodyText.length > MAX_COMMENT_TEXT_LENGTH) {
        displayCommentText = commentBodyText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...'; // Æ˜ara '...'
        hasMoreCommentText = true;
    }

    div.innerHTML = `
        <div class="comment-header">
            <div class="avatar-wrapper">
                <img src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="avatar" data-profile-src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
                <img src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" class="team-icon" data-profile-src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
            </div>
            <div class="comment-main-info">
                <span class="full-name">${comment.fullName}</span>
                <span class="comment-time">${formatTime(comment.commentTime)}</span>
            </div>
        </div>
        <div class="comment-body" data-fulltext="${encodeURIComponent(commentBodyText)}">
            ${displayCommentText}
            ${hasMoreCommentText ? `<span class="comment-learnmore">Kara Karantawa</span>` : ''}
        </div>
        <div class="comment-media">
            ${comment.imageLink1 ? `<img src="${comment.imageLink1}" class="comment-img" onerror="this.style.display='none'" />` : ''}
            ${comment.imageLink2 ? `<img src="${comment.imageLink2}" class="comment-img" onerror="this.style.display='none'" />` : ''}
            ${comment.imageLink3 ? `<img src="${comment.imageLink3}" class="comment-img" onerror="this.style.display='none'" />` : ''}
            ${comment.videoComment ? `<video src="${comment.videoComment}" class="comment-video" controls onerror="this.style.display='none'"></video>` : ''}
        </div>
        <div class="comment-actions">
            <button class="action-btn like-btn">Like. ${comment.commentLike || 0}</button>
            <button class="action-btn emoji-btn">Emoji <span class="emoji-text">${comment.commentEmoji || ''}</span></button>
            <button class="action-btn reply-btn">Reply</button>
            ${comment.userId === currentUser.uid ? `<button class="action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
        </div>
        <div class="edit-delete-actions" style="display: none;">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
        </div>
    `;

   
    const commentBodyElement = div.querySelector('.comment-body');
    const commentLearnMoreBtn = commentBodyElement ? commentBodyElement.querySelector('.comment-learnmore') : null;

    if (commentLearnMoreBtn) {
        commentLearnMoreBtn.addEventListener('click', () => {
            const fullText = decodeURIComponent(commentBodyElement.dataset.fulltext);
            commentBodyElement.innerHTML = fullText; 
            
        });
    }


    div.querySelectorAll('.comment-img').forEach(img => {
        img.onclick = () => window.showImageViewer(img.src);
    });
    div.querySelectorAll('.comment-video').forEach(video => {
        video.onclick = () => window.showVideoViewer(video.src);
    });

    const likeBtn = div.querySelector('.like-btn');
    if (likeBtn) likeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleLike(comment.id);
    });
    const replyBtn = div.querySelector('.reply-btn');
    if (replyBtn) replyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleReply(comment.id);
    });
    const emojiBtn = div.querySelector('.emoji-btn');
    if (emojiBtn) emojiBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleEmojiClick(e, comment.id, 'comment');
    });

    const moreOptionsBtn = div.querySelector('.more-options-btn');
    const editDeleteActionsDiv = div.querySelector('.edit-delete-actions');
    if (moreOptionsBtn) {
      moreOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
          editDeleteActionsDiv.classList.toggle('show-actions');
        }
      });
    }

    const avatar = div.querySelector('.avatar');
    const teamIcon = div.querySelector('.team-icon');
    if (avatar) avatar.onclick = (e) => window.showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);
    if (teamIcon) teamIcon.onclick = (e) => window.showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);


    if (comment.userId === currentUser.uid) {
      const editBtn = div.querySelector('.edit-btn');
      if (editBtn) editBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newText = await window.showInputModal("Gyara comment:", "Rubuta sabon comment din ka:", comment.commentText);
        if (newText !== null && newText.trim() !== "") {
          handleEdit(comment.id, newText);
        }
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        window.showConfirmation("Kana so ka goge wannan comment?", () => {
          handleDelete(comment.id);
        });
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
    }

    const repliesDiv = document.createElement('div');
    repliesDiv.className = 'replies';
    if (comment.replies) {
      const sortedReplies = Object.values(comment.replies).sort((a, b) => new Date(a.replyTime) - new Date(b.replyTime));
      sortedReplies.forEach(reply => {
        repliesDiv.append(renderReply(reply, comment));
      });
    }
    div.append(repliesDiv);
    return div;
  }

  function renderReply(reply, parentComment) {
    const div = document.createElement('div');
    div.className = `reply ${reply.userId === currentUser.uid ? 'user-owned' : ''}`;
    div.dataset.replyId = reply.id;

    let replyingToHtml = '';
    if (reply.replyingToReplyUserFullName) {
      replyingToHtml = `<span class="reply-by-user-name">Replying to ${reply.replyingToReplyUserFullName}</span>`;
    } else {
      replyingToHtml = `<span class="reply-by-user-name">Replying to ${parentComment.fullName}</span>`;
    }

    

    let replyBodyText = reply.commentText || '';
    let displayReplyText = replyBodyText;
    let hasMoreReplyText = false;

    if (replyBodyText.length > MAX_COMMENT_TEXT_LENGTH) {
        displayReplyText = replyBodyText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...'; // Æ˜ara '...'
        hasMoreReplyText = true;
    }

    div.innerHTML = `
        <div class="reply-header">
            <div class="avatar-wrapper">
                <img src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="avatar" data-profile-src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
                <img src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" class="team-icon" data-profile-src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
            </div>
            <div class="reply-main-info">
                <span class="full-name">${reply.fullName}</span>
                ${replyingToHtml}
                <span class="reply-time">${formatTime(reply.replyTime)}</span>
            </div>
        </div>
        <div class="reply-body" data-fulltext="${encodeURIComponent(replyBodyText)}">
            ${displayReplyText}
            ${hasMoreReplyText ? `<span class="comment-learnmore">Kara Karantawa</span>` : ''}
        </div>
        <div class="reply-media">
            ${reply.imageLink1 ? `<img src="${reply.imageLink1}" class="reply-img" onerror="this.style.display='none'" />` : ''}
            ${reply.imageLink2 ? `<img src="${reply.imageLink2}" class="reply-img" onerror="this.style.display='none'" />` : ''}
            ${reply.imageLink3 ? `<img src="${reply.imageLink3}" class="reply-img" onerror="this.style.display='none'" />` : ''}
            ${reply.videoComment ? `<video src="${reply.videoComment}" class="reply-video" controls onerror="this.style.display='none'"></video>` : ''}
        </div>
        <div class="reply-actions">
            
            <button class="action-btn reply-btn">Reply</button>
            ${reply.userId === currentUser.uid ? `<button class="action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
        </div>
        <div class="edit-delete-actions" style="display: none;">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
        </div>
    `;

    
    const replyBodyElement = div.querySelector('.reply-body');
    const replyLearnMoreBtn = replyBodyElement ? replyBodyElement.querySelector('.comment-learnmore') : null;

    if (replyLearnMoreBtn) {
        replyLearnMoreBtn.addEventListener('click', () => {
            const fullText = decodeURIComponent(replyBodyElement.dataset.fulltext);
            replyBodyElement.innerHTML = fullText;
        });
    }


    div.querySelectorAll('.reply-img').forEach(img => {
        img.onclick = () => window.showImageViewer(img.src);
    });
    div.querySelectorAll('.reply-video').forEach(video => {
        video.onclick = () => window.showVideoViewer(video.src);
    });

    const likeBtn = div.querySelector('.like-btn');
    if (likeBtn) likeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleLikeReply(parentComment.id, reply.id);
    });
    const replyBtn = div.querySelector('.reply-btn');
    if (replyBtn) replyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleReply(parentComment.id, reply.id);
    });

    const moreOptionsBtn = div.querySelector('.more-options-btn');
    const editDeleteActionsDiv = div.querySelector('.edit-delete-actions');
    if (moreOptionsBtn) {
      moreOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
          editDeleteActionsDiv.classList.toggle('show-actions');
        }
      });
    }

    const avatar = div.querySelector('.avatar');
    const teamIcon = div.querySelector('.team-icon');
    if (avatar) avatar.onclick = (e) => window.showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);
    if (teamIcon) teamIcon.onclick = (e) => window.showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);

    if (reply.userId === currentUser.uid) {
      const editBtn = div.querySelector('.edit-btn');
      if (editBtn) editBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newText = await window.showInputModal("Gyara reply:", "Rubuta sabon reply din ka:", reply.commentText);
        if (newText !== null && newText.trim() !== "") {
          handleEditReply(parentComment.id, reply.id, newText);
        }
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        window.showConfirmation("Kana so ka goge wannan reply?", () => {
          handleDeleteReply(parentComment.id, reply.id);
        });
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
    }
    return div;
  }


  function handleLike(commentId) {
    const commentRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment/${commentId}`);
    runTransaction(commentRef, (comment) => {
      if (comment) {
        if (!comment.commentLike) {
          comment.commentLike = 0;
        }
        comment.commentLike++;
      }
      return comment;
    });
  }

  function handleLikeReply(commentId, replyId) {
    const replyRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment/${commentId}/replies/${replyId}`); 
    runTransaction(replyRef, (reply) => {
      if (reply) {
        if (!reply.replyLike) {
          reply.replyLike = 0;
        }
        reply.replyLike++;
      }
      return reply;
    });
  }

  function handleReply(commentId, parentReplyId = null) {
    replyingToOriginalCommentId = commentId;
    replyingToParentReplyId = parentReplyId;

    const originalComment = commentsCache.find(c => c.id === commentId);
    let targetUserName = originalComment ? originalComment.fullName : 'Unknown User';

    if (parentReplyId) {
      if (originalComment && originalComment.replies) {
        const parentReply = Object.values(originalComment.replies).find(r => r.id === parentReplyId);
        if (parentReply) {
          targetUserName = parentReply.fullName;
        }
      }
    }

    if (commentInput) {
      commentInput.placeholder = `Replying to ${targetUserName}...`;
      commentInput.focus();
    }
  }

  function handleEmojiClick(event, commentId, type) {
    event.stopPropagation();

    const emojiContainer = document.getElementById('emoji-container');
    if (!emojiContainer) {
      console.error("Emoji container not found. Make sure you have a div with id 'emoji-container' in your HTML.");
      return;
    }

    const rect = event.currentTarget.getBoundingClientRect();

    emojiContainer.style.position = 'fixed';
    let topPosition = rect.bottom + 10;
    if (topPosition + emojiContainer.offsetHeight > window.innerHeight && rect.top - emojiContainer.offsetHeight - 10 > 0) {
      topPosition = rect.top - emojiContainer.offsetHeight - 10;
    }
    emojiContainer.style.top = `${topPosition}px`;
    emojiContainer.style.left = `${rect.left}px`;
    emojiContainer.style.transform = 'translateX(0)';

    if (rect.left + emojiContainer.offsetWidth > window.innerWidth) {
      emojiContainer.style.left = `${window.innerWidth - emojiContainer.offsetWidth - 10}px`;
    }

    emojiContainer.style.maxWidth = '300px';
    emojiContainer.style.display = 'flex';
    emojiContainer.classList.add('show');

    const emojiIcons = ['ğŸ‘', 'ğŸ¤¦â€â™€ï¸', 'ğŸ‘ï¸', 'âŒ', 'ğŸ™†â€â™‚ï¸', 'ğŸ¤š', 'ğŸ¤œ', 'ğŸ˜†', 'ğŸ˜„', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ‘¹', 'ğŸ™‰', 'ğŸ’', 'â¤ï¸', 'ğŸ’¯', 'ğŸ’¥', 'ğŸ‘©â€ğŸ¤', 'ğŸ‘©â€ğŸŒ¾', 'ğŸ™‹â€â™€ï¸', 'ğŸ’', 'ğŸ¦', 'ğŸ«', 'ğŸ¦“', 'ğŸ¦„', 'ğŸŸ', 'âš½', 'ğŸ…', 'ğŸ†', 'ğŸ¥‡', 'ğŸ‰', 'ğŸŠ', 'ğŸ'];

    let emojiHtml = `<span class="emoji-icon close-emoji-btn">âŒ</span>`;
    emojiHtml += emojiIcons.map(icon => `<span class="emoji-icon">${icon}</span>`).join('');
    emojiContainer.innerHTML = emojiHtml;

    emojiContainer.querySelectorAll('.emoji-icon').forEach(icon => {
      icon.onclick = (e) => {
        e.stopPropagation();
        emojiContainer.style.display = 'none';
        emojiContainer.classList.remove('show');
        if (!icon.classList.contains('close-emoji-btn')) {
          updateEmoji(commentId, icon.textContent, type);
        }
      };
    });
  }


  function updateEmoji(commentId, emoji, type) {
    let path = `KaiTsayePost/${kaiTsayePostIdForComments}/Comment/${commentId}`;
    if (type === 'comment') {
      const emojiRef = ref(db, path);
      update(emojiRef, {
        [`${type}Emoji`]: emoji
      });
    }
  }


  function handleEdit(commentId, newText) {
    const commentRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment/${commentId}`); 
    update(commentRef, {
      commentText: newText
    });
    window.showNotification("An gyara comment naka.");
  }

  function handleDelete(commentId) {
    const commentRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment/${commentId}`); 
    remove(commentRef).then(() => {
      window.showNotification("An goge comment naka.");
    
      const totalCommentRef = ref(db, `KaiTsayePost/totalComment`);
      runTransaction(totalCommentRef, (currentValue) => {
          return (currentValue || 0) - 1;
      });
    }).catch(error => {
      console.error("Kuskure wajen goge comment:", error);
      window.showNotification("An kasa goge comment.");
    });
  }

  function handleEditReply(commentId, replyId, newText) {
    const replyRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment/${commentId}/replies/${replyId}`); 
    update(replyRef, {
      commentText: newText
    });
    window.showNotification("An gyara reply naka.");
  }

  function handleDeleteReply(commentId, replyId) {
    const replyRef = ref(db, `KaiTsayePost/${kaiTsayePostIdForComments}/Comment/${commentId}/replies/${replyId}`);
    remove(replyRef).then(() => {
      window.showNotification("An goge reply naka.");
     
      const totalCommentRef = ref(db, `KaiTsayePost/totalComment`); 
      runTransaction(totalCommentRef, (currentValue) => {
          return (currentValue || 0) - 1;
      });
    }).catch(error => {
      console.error("Kuskure wajen goge reply:", error);
      window.showNotification("An kasa goge reply.");
    });
  }

  
  window.downloadMedia = function(src, type) {
    const link = document.createElement('a');
    link.href = src;
    link.download = (type === 'image' || type === 'img') ? 'image.jpg' : 'video.mp4';
    link.click();
  }

  function formatTime(dateStr) {
    const dt = new Date(dateStr);
    return dt.toLocaleString('ha-NG', {
      hour12: true
    });
  }

 
  window.showNotification = function(message) {
    const container = document.getElementById('notification-container');
    if (!container) {
      console.error("Notification container not found. Add <div id='notification-container'></div> to your HTML.");
      return;
    }
    container.innerHTML = '';
    const notificationBox = document.createElement('div');
    notificationBox.className = 'notification-box';
    notificationBox.textContent = message;
    container.append(notificationBox);
    container.classList.add('show');
    setTimeout(() => {
      container.classList.remove('show');
      container.innerHTML = '';
    }, 5000);
  };

  window.showConfirmation = function(message, onConfirm) {
    const container = document.getElementById('notification-container');
    if (!container) {
      console.error("Notification container not found. Add <div id='notification-container'></div> to your HTML.");
      return;
    }
    container.innerHTML = '';
    const confirmationBox = document.createElement('div');
    confirmationBox.className = 'notification-box confirmation-box';
    confirmationBox.innerHTML = `
        <span>${message}</span>
        <div class="confirm-buttons">
          <button id="confirm-yes">Eh</button>
          <button id="confirm-no">A'a</button>
        </div>
    `;
    container.append(confirmationBox);
    container.classList.add('show');

    document.getElementById('confirm-yes').onclick = () => {
      onConfirm();
      container.classList.remove('show');
      container.innerHTML = '';
    };
    document.getElementById('confirm-no').onclick = () => {
      container.classList.remove('show');
      container.innerHTML = '';
    };
  };

  window.showInputModal = function(title, message, defaultValue = '') {
    return new Promise((resolve) => {
      const container = document.getElementById('notification-container');
      if (!container) {
        console.error("Notification container not found. Add <div id='notification-container'></div> to your HTML.");
        resolve(null);
        return;
      }
      container.innerHTML = '';
      const modalHtml = `
        <div id="custom-input-modal" class="notification-box confirmation-box">
          <h3>${title}</h3>
          <span>${message}</span>
          <input type="text" id="custom-input-field" value="${defaultValue}" style="width: 90%; padding: 8px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc;"/>
          <div class="confirm-buttons" style="margin-top: 15px;">
            <button id="input-confirm-ok" style="background-color: #28a745;">OK</button>
            <button id="input-confirm-cancel" style="background-color: #dc3545;">A'a</button>
          </div>
        </div>
      `;
      container.innerHTML = modalHtml;
      container.classList.add('show');

      const inputField = document.getElementById('custom-input-field');
      if (inputField) inputField.focus();

      document.getElementById('input-confirm-ok').onclick = () => {
        const value = inputField ? inputField.value : '';
        container.classList.remove('show');
        container.innerHTML = '';
        resolve(value);
      };
      document.getElementById('input-confirm-cancel').onclick = () => {
        container.classList.remove('show');
        container.innerHTML = '';
        resolve(null);
      };
    });
  };

  window.showImageViewer = function(src) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) {
        console.error("Modal viewer not found. Add <div id='modal-viewer' class='hidden'></div> to your HTML.");
        return;
    }
    modal.innerHTML = `
      <div class="modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <img src="${src}" alt="Image" onerror="this.src='https://placehold.co/400x300/e0e0e0/000000?text=Hoton+Baya+Nan'" />
        <button class="download-btn" title="Download"><i class="fas fa-download"></i></button>
      </div>
    `;
    modal.classList.remove('hidden');
    modal.querySelector('.close-btn').onclick = () => modal.classList.add('hidden');
    const downloadBtn = modal.querySelector('.download-btn');
    if (downloadBtn) downloadBtn.onclick = () => window.downloadMedia(src, 'image');
  };

  window.showVideoViewer = function(src) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) {
        console.error("Modal viewer not found. Add <div id='modal-viewer' class='hidden'></div> to your HTML.");
        return;
    }
    modal.innerHTML = `
      <div class="modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <video src="${src}" controls autoplay onerror="this.src=''" onplay="this.onerror=null; console.warn('Video not loaded, check URL/format');"></video>
        <button class="download-btn" title="Download"><i class="fas fa-download"></i></button>
      </div>
    `;
    modal.classList.remove('hidden');
    modal.querySelector('.close-btn').onclick = () => modal.classList.add('hidden');
    const downloadBtn = modal.querySelector('.download-btn');
    if (downloadBtn) downloadBtn.onclick = () => window.downloadMedia(src, 'video');
  };

  window.showProfileViewer = function(profileUrl, teamUrl) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) {
        console.error("Modal viewer not found. Add <div id='modal-viewer' class='hidden'></div> to your HTML.");
        return;
    }
    modal.innerHTML = `
      <div class="profile-modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <img src="${profileUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="profile-image-fullscreen" alt="Profile Image" onerror="this.src='https://i.imgur.com/CgvdgMA.png'" />
        <img src="${teamUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="team-logo-overlay" alt="Team Logo" onerror="this.src='https://i.imgur.com/CgvdgMA.png'" />
      </div>
    `;
    modal.classList.remove('hidden');
    modal.querySelector('.close-btn').onclick = () => modal.classList.add('hidden');
  };

 
  document.addEventListener('click', (event) => {
    const emojiContainer = document.getElementById('emoji-container');
    if (emojiContainer && emojiContainer.style.display === 'flex') {
      if (!emojiContainer.contains(event.target) && !event.target.closest('.emoji-btn')) {
        emojiContainer.style.display = 'none';
        emojiContainer.classList.remove('show');
      }
    }
  });
</script>

</body>
</html>
