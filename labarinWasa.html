<!DOCTYPE html>
<html lang="ha">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Labarin Wasan Kwallo - TauraronWasa</title>
  <link rel="icon" href="https://i.imgur.com/CgvdgMA.png" />
  <style>
    /* Background football themed */
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #181d27 url('https://images.unsplash.com/photo-1517649763962-0c623066013b?auto=format&fit=crop&w=1200&q=80') center/cover no-repeat;
      min-height: 100vh;
      color: #f5f6fa;
      position: relative;
    }

    .overlay {
      position: fixed;
      z-index: 1000;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(24,29,39,0.98) center center;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity .5s;
    }

    .loader {
      width: 80px;
      height: 80px;
      border: 8px solid #222c3a;
      border-top: 8px solid #f5c518;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      to {transform: rotate(360deg);}
    }

    .logo {
      display: block;
      margin: 40px auto 10px auto;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 20px #000a;
      object-fit: contain;
    }

    .match-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 32px;
      font-size: 1.7rem;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 10px;
      text-align: center;
    }
    .team {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px;
    }
    .team img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #fff;
      margin-bottom: 8px;
      box-shadow: 0 1px 10px #000b;
      object-fit: contain;
    }
    .score {
      font-size: 2rem;
      font-weight: bold;
      color: #f5c518;
      margin: 0 10px;
    }
    .info {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.05rem;
      opacity: .92;
    }
    .match-details {
      background: rgba(24,29,39,0.85);
      border-radius: 18px;
      padding: 22px 28px;
      margin: 0 auto;
      max-width: 640px;
      box-shadow: 0 2px 25px #0006;
      margin-bottom: 32px;
    }
    .details-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 14px;
      color: #f5c518;
      text-align: center;
    }
    .details-body {
      font-size: 1.1rem;
      line-height: 1.7;
      color: #f5f6fa;
      text-align: left;
      min-height: 60px;
    }
    .venue, .extra-info {
      font-size: 1rem;
      color: #ccc;
      margin-top: 4px;
      margin-bottom: 7px;
      text-align: center;
      opacity: .8;
    }
    .error-message {
      background: #c0392b;
      color: #fff;
      padding: 18px 32px;
      border-radius: 10px;
      margin: 80px auto;
      font-size: 1.2rem;
      text-align: center;
      max-width: 380px;
      box-shadow: 0 2px 16px #000a;
    }
    @media (max-width: 600px) {
      .match-details { padding: 12px 8px; }
      .match-header {gap: 10px; font-size: 1.1rem;}
      .details-title { font-size: 1.07rem;}
    }
  </style>
</head>
<body>
  <div id="overlay" class="overlay">
    <div>
      <div class="loader"></div>
      <div style="text-align:center;font-size:1.2rem">
        Ana loda bayanai...
      </div>
    </div>
  </div>

  <img src="https://i.imgur.com/CgvdgMA.png" alt="TauraronWasa Logo" class="logo" />
  <div id="app"></div>

  <script>
    // ⚽️ Main entry
    const overlay = document.getElementById("overlay");
    const app = document.getElementById("app");
    const FOOTBALL_API_TOKEN = "b75541b8a8cc43719195871aa2bd419e";
    const TRANSLATE_API_KEY = "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";
    const TRANSLATE_API_URL = "https://openrouter.ai/api/v1/chat/completions";

    function showOverlay(show = true) {
      overlay.style.display = show ? "flex" : "none";
      overlay.style.opacity = show ? "1" : "0";
    }
    // Error handler
    function showError(msg) {
      showOverlay(false);
      app.innerHTML = `<div class="error-message">${msg}</div>`;
    }

    // Utility: get item from localStorage with fallback
    function getMatchDataFromLS() {
      try {
        // Expected: setMatchData({homeTeam, awayTeam, date, time, year, matchId, userId})
        const data = JSON.parse(localStorage.getItem("selectedMatch"));
        return data || null;
      } catch {
        return null;
      }
    }

    // Football API request
    async function fetchMatchDetails(matchId) {
      try {
        const res = await fetch(`https://api.football-data.org/v4/matches/${matchId}`, {
          headers: { "X-Auth-Token": FOOTBALL_API_TOKEN }
        });
        if (!res.ok) throw new Error("api error");
        return await res.json();
      } catch {
        return null;
      }
    }

    // Fallback: Custom search if matchId not found
    async function searchMatchByTeamsAndDate(home, away, date) {
      try {
        const res = await fetch(`https://api.football-data.org/v4/matches?dateFrom=${date}&dateTo=${date}`, {
          headers: { "X-Auth-Token": FOOTBALL_API_TOKEN }
        });
        if (!res.ok) throw new Error("api error");
        const data = await res.json();
        const found = data.matches.find(
          m => m.homeTeam?.name?.toLowerCase() === home.toLowerCase() && m.awayTeam?.name?.toLowerCase() === away.toLowerCase()
        );
        return found || null;
      } catch {
        return null;
      }
    }

    // Translate to Hausa using OpenRouter API
    async function translateToHausa(text) {
      try {
        const res = await fetch(TRANSLATE_API_URL, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${TRANSLATE_API_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "openai/gpt-4o",
            messages: [{
              role: "user",
              content: `
Ka fassara wannan zuwa hausa, wadda kowa zai Gane ba tare da kowa ya Gane ka fassara ba. Kada ka rubuta wani jawabi ko misali ko tambaya, ka dawo da fassara kawai.
${text}
`
            }]
          })
        });
        if (!res.ok) throw new Error("translation error");
        const out = await res.json();
        return out.choices?.[0]?.message?.content?.trim() || "";
      } catch {
        return null;
      }
    }

    // Render UI
    async function renderMatch() {
      showOverlay(true);
      let matchData = getMatchDataFromLS();

      if (!matchData) return showError("akwai matsala ka sake gwadawa");

      // If we have matchId, fetch direct; else search
      let matchDetails;
      if (matchData.matchId) {
        matchDetails = await fetchMatchDetails(matchData.matchId);
      }
      if (!matchDetails) {
        matchDetails = await searchMatchByTeamsAndDate(matchData.homeTeam, matchData.awayTeam, matchData.date);
      }
      if (!matchDetails) return showError("akwai matsala network ka sake gwadawa");

      // Prepare match info for UI
      const {
        homeTeam, awayTeam, score, status, utcDate, venue, competition, referees, matchday,
      } = matchDetails;
      // Short details for translation
      let shortDetails = "";
      if (status === "FINISHED" || status === "ENDED") {
        shortDetails += `This game is end. Score: ${score.fullTime.home} - ${score.fullTime.away}.`;
      } else if (status === "IN_PLAY") {
        shortDetails += "Wasan yana gudana.";
      } else if (status === "SCHEDULED") {
        shortDetails += "Wasan bai fara ba.";
      }
      shortDetails += ` ${homeTeam.name} VS ${awayTeam.name}.`;
      // Extra info
      if (venue) shortDetails += ` Venue: ${venue}.`;
      if (competition?.name) shortDetails += ` Competition: ${competition.name}.`;
      if (matchday) shortDetails += ` Matchday: ${matchday}.`;

      // Translate to Hausa
      let detailsHausa = await translateToHausa(shortDetails);
      if (!detailsHausa) return showError("akwai matsala ka sake gwadawa");

      // Format date/time
      const dt = new Date(utcDate);
      const matchTime = dt.toLocaleTimeString("en-GB", {hour: '2-digit', minute: '2-digit'});
      const matchDate = dt.toLocaleDateString("en-GB");
      const refereeNames = referees?.map(r => r.name).join(", ");

      // Render main UI
      app.innerHTML = `
      <div class="match-header">
        <span class="team">
          <img src="${homeTeam.crest || 'https://i.imgur.com/CgvdgMA.png'}" alt="${homeTeam.name}" />
          <span>${homeTeam.name}</span>
        </span>
        <span class="score">${score?.fullTime?.home ?? '-'}</span>
        <span>VS</span>
        <span class="score">${score?.fullTime?.away ?? '-'}</span>
        <span class="team">
          <img src="${awayTeam.crest || 'https://i.imgur.com/CgvdgMA.png'}" alt="${awayTeam.name}" />
          <span>${awayTeam.name}</span>
        </span>
      </div>
      <div class="info">
        ${status === "FINISHED" ? "Lokacin: " + matchTime + ", " + matchDate : ""}
        ${competition?.name ? "Gasar: " + competition.name : ""}
        ${venue ? "<br/>Filin wasa: " + venue : ""}
        ${refereeNames ? "<br/>Alkalan wasa: " + refereeNames : ""}
      </div>
      <div class="match-details">
        <div class="details-title">Labarin Wasa</div>
        <div class="details-body">${detailsHausa}</div>
      </div>
      `;

      showOverlay(false);
    }

    // Remove sensitive data from LS on unload
    window.addEventListener("beforeunload", () => {
      localStorage.removeItem("selectedMatch");
    });

    // Run main
    renderMatch();

  </script>
</body>
</html>