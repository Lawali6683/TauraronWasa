<!DOCTYPE html>
<html lang="ha">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Labarin Wasa - TauraronWasa</title>
<link rel="icon" href="https://i.imgur.com/CgvdgMA.png" />
<style>
:root {
    --bg: #0e0e0e;
    --bg-glass: rgba(30,30,30,0.85);
    --fg: #f4f4f4;
    --accent: #16e7cf;
    --danger: #ff4d4d;
    --success: #00ff88;
    --info: #ffeb3b;
    --card-radius: 18px;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.22);
    --transition: all 0.3s cubic-bezier(.75,.16,.47,1.13);
}
body {
    font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--fg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
}
.loading-backdrop {
    position: fixed;
    z-index: 9000;
    inset: 0;
    background: linear-gradient(to bottom, #180022, #300040);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.3s, visibility 0.3s;
    text-align: center;
}
.loading-backdrop.hidden { opacity: 0; visibility: hidden; }
.lds-roller { display:inline-block; position:relative; width:72px; height:72px; }
.lds-roller div {
    animation: lds-roller 1.2s cubic-bezier(0.6, 0, 0.6, 1) infinite;
    transform-origin: 36px 36px;
}
.lds-roller div:after {
    content: " ";
    display: block;
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent);
    margin: -4px 0 0 -4px;
}
.lds-roller div:nth-child(1){animation-delay:-0.036s;top:63px;left:63px;}
.lds-roller div:nth-child(2){animation-delay:-0.072s;top:68px;left:56px;}
.lds-roller div:nth-child(3){animation-delay:-0.108s;top:71px;left:48px;}
.lds-roller div:nth-child(4){animation-delay:-0.144s;top:72px;left:39px;}
.lds-roller div:nth-child(5){animation-delay:-0.18s;top:71px;left:31px;}
.lds-roller div:nth-child(6){animation-delay:-0.216s;top:68px;left:24px;}
.lds-roller div:nth-child(7){animation-delay:-0.252s;top:63px;left:17px;}
.lds-roller div:nth-child(8){animation-delay:-0.288s;top:56px;left:12px;}
@keyframes lds-roller { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
#main-content {
    width: 100%;
    max-width: 800px;
    padding: 20px;
}
.match-card {
    background: var(--bg-glass);
    border-radius: var(--card-radius);
    box-shadow: var(--card-shadow);
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}
.team-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.team {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 35%;
}
.team img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #fff;
    object-fit: contain;
    margin-bottom: 10px;
}
.score-area {
    width: 30%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.score {
    font-size: 3rem;
    font-weight: 900;
    color: var(--accent);
    line-height: 1;
}
.status-live { color: var(--success); font-weight: bold; font-size: 1.1em; }
.status-finished { color: var(--danger); font-weight: bold; font-size: 1.1em; }
.status-scheduled { color: var(--info); font-weight: bold; font-size: 1.1em; }
.status-error { color: var(--danger); font-weight: bold; font-size: 1.1em; }
.live-min { color: var(--success); font-weight: bold; margin-top: 5px; }
.match-date-time {
    font-size: 1.2em;
    opacity: 0.9;
    margin-top: 10px;
    font-weight: 500;
}
.gpt-analysis-card {
    background: var(--bg-glass);
    border-radius: var(--card-radius);
    box-shadow: var(--card-shadow);
    padding: 25px;
    margin-top: 20px;
}
.gpt-analysis-card h2 {
    color: var(--info);
    border-bottom: 2px solid rgba(255, 235, 59, 0.2);
    padding-bottom: 10px;
    margin-top: 0;
}
.gpt-analysis-card p {
    line-height: 1.6;
    text-align: justify;
    margin-bottom: 15px;
}
.error-msg {
    color: var(--danger);
    text-align: center;
    margin-top: 40px;
    font-size: 1.2em;
}

    .LodingLogo {
  width: 70px;
  height: 70px;
  filter: drop-shadow(0 0 10px #ffd700);
  animation: glowEffect 2s infinite ease-in-out;
}


@keyframes glowEffect {
  0% {
    filter: drop-shadow(0 0 5px #ffd700);
  }
  50% {
    filter: drop-shadow(0 0 20px #ffea00);
  }
  100% {
    filter: drop-shadow(0 0 5px #ffd700);
  }
}
</style>
</head>
<body>
<div class="loading-backdrop" id="loading-backdrop">
    <span class="lds-roller">
        <div></div><div></div><div></div><div></div>
        <div></div><div></div><div></div><div></div>
        <img src="https://i.imgur.com/CgvdgMA.png" class="LodingLogo">
    </span>
</div>
<img src="https://i.imgur.com/CgvdgMA.png" alt="Logo" style="width:100px;margin-top:25px;border-radius:50%;" />
<div id="main-content">
    <div id="match-container"></div>
    <div id="gpt-analysis" class="gpt-analysis-card" style="display: none;">
        <h2>Takaitaccen Nazarin Tarihin Wasan Su</h2>
        <div id="gpt-text"></div>
    </div>
</div>
<script>
const LABARI_KEY = "site6_labariGame";
const LABARI_CACHE_KEY = "site6_labariGameCache"; 
const REQUEST_API_URL = "https://tauraronwasaadmin.pages.dev/api/labari";
const REQUEST_KEY = "@haruna66";
const backdrop = document.getElementById("loading-backdrop");
const matchContainer = document.getElementById("match-container");
const gptAnalysis = document.getElementById("gpt-analysis");
const gptText = document.getElementById("gpt-text");
let liveUpdateInterval = null;
let initialRequestCompleted = false; 

function getMatchIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

function site6ParseUTCDate(timestamp) {
    const parts = timestamp.replace('Z', '').split('T');
    if (parts.length !== 2) return null;
    const dateParts = parts[0].split('-').map(Number);
    const timeParts = parts[1].split(':').map(Number);
    if (dateParts.length < 3 || timeParts.length < 3) return null;
    const date = new Date();
    date.setUTCFullYear(dateParts[0], dateParts[1] - 1, dateParts[2]); 
    date.setUTCHours(timeParts[0], timeParts[1], timeParts[2], 0);
    return date;
}

function formatFullDate(utc) {
    const date = site6ParseUTCDate(utc);
    if (!date || isNaN(date.getTime())) return "Lokaci Kuskure";
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
    return new Intl.DateTimeFormat('ha-NG', options).format(date);
}

function showLoading(show = true) { backdrop.classList.toggle("hidden", !show); }
function showError(msg) { showLoading(false); matchContainer.innerHTML = `<div class='error-msg'>${msg}</div>`; }

function getStatusText(status) {
    switch(status){
        case "IN_PLAY": return `<span class='status-live'>Yana gudana üî¥</span>`;
        case "PAUSED": return `<span class='status-live'>An dakata ‚è∏Ô∏è</span>`;
        case "FINISHED": return `<span class='status-finished'>An gama ‚úÖ</span>`;
        case "TIMED": case "SCHEDULED": return `<span class='status-scheduled'>üïí</span>`;
        default: return `<span class='status-error'>Status Ba a dawo ba</span>`;
    }
}

function getLiveMatchTime(match) {
    const startDate = site6ParseUTCDate(match.utcDate);
    if (!startDate || match.status !== 'IN_PLAY') return "";
    const now = new Date();
    const diffInMilliseconds = now - startDate;
    const diffInMinutes = Math.floor(diffInMilliseconds / (1000 * 60));
    if (diffInMinutes >= 0) return `${diffInMinutes}'`; 
    return ""; 
}

function isPastMatch(utcDate) {
    const date = site6ParseUTCDate(utcDate);
    if (!date) return false;
    const twoHoursAfterScheduled = 2 * 60 * 60 * 1000; 
    return (new Date().getTime() - date.getTime()) > twoHoursAfterScheduled;
}

function renderMatch(fullData) {
    const apiGame = fullData.matchStatus; 
    const gptResponse = fullData.gptAnalysis?.response_text;
    const basicDataFromWorker = fullData.basicMatchData; 
    
    let game = apiGame; 
    
    if (!game) {
        game = basicDataFromWorker || {};
    }
    
    if (!game.matchId && !game.homeTeam) {
        showError("Babu bayanin wasan da aka samu. Da fatan za a koma shafin gida.");
        return;
    }
    
    matchContainer.innerHTML = '';
    const card = document.createElement("div");
    card.className = "match-card";
    
    let finalStatus = game.status || 'SCHEDULED';
    let scoreDisplay = 'VS';
    let liveTime = '';

    if ((finalStatus === 'SCHEDULED' || finalStatus === 'TIMED') && game.utcDate && isPastMatch(game.utcDate)) {
        finalStatus = 'FINISHED'; 
    }
    
    let isLive = ["IN_PLAY", "PAUSED"].includes(finalStatus);
    let isFinished = finalStatus === 'FINISHED';
    
    const currentHomeTeam = { 
        name: game.homeTeam?.name || game.homeTeamName || game.homeTeam || 'Ba a Samu Ba', 
        crest: game.homeTeam?.crest || game.homeCrest || 'placeholder.png' 
    };
    const currentAwayTeam = { 
        name: game.awayTeam?.name || game.awayTeamName || game.awayTeam || 'Ba a Samu Ba', 
        crest: game.awayTeam?.crest || game.awayCrest || 'placeholder.png' 
    };
    
    if (game.score) {
        const score = game.score;
        if (isFinished) {
            const homeScore = score.fullTime?.home ?? '';
            const awayScore = score.fullTime?.away ?? '';
            scoreDisplay = `${homeScore} - ${awayScore}`;
        } else if (isLive) {
            const homeScore = score.current?.home ?? score.halfTime?.home ?? 0;
            const awayScore = score.current?.away ?? score.halfTime?.away ?? 0;
            scoreDisplay = `${homeScore} - ${awayScore}`;
            liveTime = finalStatus === 'PAUSED' ? 'An dakata' : getLiveMatchTime(game);
        } else {
            scoreDisplay = 'VS';
        }
    } else if (isFinished || isLive) { 
        scoreDisplay = 'VS'; 
    } else {
        scoreDisplay = 'VS';
    }
    
    const matchInfoHtml = `
        <div class="match-date-time">
            ${getStatusText(finalStatus)} | ${formatFullDate(game.utcDate || '')}
        </div>
    `;
    card.innerHTML = `
        <div class="team-section">
            <div class="team">
                <img src="${currentHomeTeam.crest || 'placeholder.png'}" alt="${currentHomeTeam.name}">
                <div>${currentHomeTeam.name || 'Ba a Samu Ba'}</div>
            </div>
            <div class="score-area">
                <div class="score">${scoreDisplay}</div>
                ${isLive && liveTime ? `<div class="live-min">${liveTime}</div>` : ''}
            </div>
            <div class="team">
                <img src="${currentAwayTeam.crest || 'placeholder.png'}" alt="${currentAwayTeam.name}">
                <div>${currentAwayTeam.name || 'Ba a Samu Ba'}</div>
            </div>
        </div>
        ${matchInfoHtml}
    `;
    matchContainer.appendChild(card);
    
    if (gptResponse && gptResponse !== "An kasa samun nazarin tarihi na AI." && gptResponse !== "Kuskure wajen karbar nazarin GPT." && gptResponse !== "Babban kuskure a server.") {
        gptText.innerHTML = gptResponse;
        gptAnalysis.style.display = 'block';
    } else {
        gptAnalysis.style.display = 'none';
    }
}

function saveMatchDataToLocal(data) {
    const newGame = data.matchStatus;
    if (!newGame || !newGame.id) return; 
    
    const homeName = newGame.homeTeam?.name || newGame.homeTeamName;
    const awayName = newGame.awayTeam?.name || newGame.awayTeamName;
    const homeCrest = newGame.homeTeam?.crest || newGame.homeCrest;
    const awayCrest = newGame.awayTeam?.crest || newGame.awayCrest;

    localStorage.setItem(LABARI_KEY + newGame.id, JSON.stringify({
        matchId: newGame.id, 
        homeTeam: homeName, 
        awayTeam: awayName, 
        homeCrest: homeCrest, 
        awayCrest: awayCrest, 
        utcDate: newGame.utcDate,
        status: newGame.status,
        score: newGame.score || null
    }));

    localStorage.setItem(LABARI_CACHE_KEY + newGame.id, JSON.stringify(data));
}

function startLiveUpdate(matchId) {
    if (liveUpdateInterval) clearInterval(liveUpdateInterval);
    liveUpdateInterval = setInterval(async () => {
        try {
            const fullData = await fetchMatchData(matchId); 
            
            if (fullData.matchStatus) { 
                saveMatchDataToLocal(fullData); 
            }
            
            renderMatch(fullData);
            if (fullData.matchStatus && fullData.matchStatus.status === 'FINISHED') {
                clearInterval(liveUpdateInterval);
                liveUpdateInterval = null;
            }
        } catch (error) {
            console.error(error.message);
        }
    }, 60000); 
}

async function fetchMatchData(matchId, homeTeam = null, awayTeam = null, homeCrest = null, awayCrest = null, utcDate = null) {
    const bodyData = { 
        matchId,
        homeTeam, 
        awayTeam,
        homeCrest, 
        awayCrest,
        utcDate 
    };

    try {
        const response = await fetch(REQUEST_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': REQUEST_KEY 
            },
            body: JSON.stringify(bodyData)
        });
        
        const data = await response.json();

        if (data.error && !data.gptAnalysis) {
             throw new Error(data.message || `HTTP Error: ${response.status}`);
        }
        
        return data;
    } catch (error) {
        throw new Error(`Kuskure wajen karbar data daga API: ${error.message}`);
    }
}

async function initLabarinWasa() {
    showLoading(true);
    const matchId = getMatchIdFromUrl();
    
    if (!matchId) {
        showError("Ba a samar da ID na wasa ba a cikin URL.");
        return;
    }

    const fullCacheData = JSON.parse(localStorage.getItem(LABARI_CACHE_KEY + matchId));
    if (fullCacheData && (fullCacheData.matchStatus || fullCacheData.basicMatchData)) {
        renderMatch(fullCacheData);
        initialRequestCompleted = true;
        showLoading(false);
        
        const apiStatus = fullCacheData.matchStatus?.status;
        if (apiStatus && (apiStatus === 'TIMED' || apiStatus === 'SCHEDULED' || apiStatus === 'IN_PLAY' || apiStatus === 'PAUSED')) {
            startLiveUpdate(matchId);
        }
        return;
    }

    const basicMatchData = JSON.parse(localStorage.getItem(LABARI_KEY + matchId));

    if (!basicMatchData || !basicMatchData.matchId || !basicMatchData.homeTeam || !basicMatchData.utcDate) {
        showError("Babu bayanin wasan da aka samu. Da fatan za a koma shafin gida.");
        return;
    }
    
    const { homeTeam, awayTeam, utcDate, homeCrest, awayCrest, status } = basicMatchData;

    try {
        const fullData = await fetchMatchData(matchId, homeTeam, awayTeam, homeCrest, awayCrest, utcDate);
        
        if (fullData.matchStatus) {
             saveMatchDataToLocal(fullData); 
             
             renderMatch(fullData);
             
             const apiStatus = fullData.matchStatus.status;
             if (apiStatus && (apiStatus === 'TIMED' || apiStatus === 'SCHEDULED' || apiStatus === 'IN_PLAY' || apiStatus === 'PAUSED')) {
                 startLiveUpdate(matchId);
             }
        } else {
             renderMatch({ 
                matchStatus: null, 
                gptAnalysis: fullData.gptAnalysis, 
                basicMatchData: basicMatchData
             });
        }
        
        initialRequestCompleted = true; 
        
    } catch (error) {
        console.error("Initial Fetch failed completely. Rendering from LocalStorage only.", error.message);
        
        if (liveUpdateInterval) clearInterval(liveUpdateInterval);
        liveUpdateInterval = null;
        
        renderMatch({ 
            matchStatus: null, 
            gptAnalysis: null, 
            basicMatchData: basicMatchData
        }); 
        
    } finally {
        showLoading(false);
    }
}
document.addEventListener("DOMContentLoaded", initLabarinWasa);
</script>
</body>
</html>
