<!DOCTYPE html>
<html lang="ha">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauraron Wasa Post</title>
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        
        /* üî±‚úîÔ∏èSite 1, ya fara daga nan, ‚úîÔ∏è */

body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(to bottom, #180022, #300040);
    background-repeat: no-repeat;
    background-attachment: fixed; 
    background-size: cover;
    color: #ffffff;
    transition: background 0.6s, color 0.6s;
}

#main-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 24px 12px 80px 12px;
    min-height: 100vh;
        
}


#post-banner {
    width: 100%;
    min-height: 220px;
    border-radius: 18px;
    overflow: hidden;
    margin-bottom: 10px;
    display: flex;
    gap: 10px;
    background: rgba(0,0,0,0.14);
    align-items: center;
    justify-content: center;
}
#post-banner img, #post-banner video {
    width: 100%;
    max-height: 320px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: transform 0.2s;
}
#post-banner img:hover, #post-banner video:hover {
    transform: scale(1.01);
}



#post-content {
    padding: 10px 0;
    font-size: 1rem;
    font-weight: 600;
    white-space: pre-line;
    background: rgba(24,0,34,0.09);
    border-radius: 10px;
    margin-bottom: 8px;
}

#post-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    font-size: 0.97em;
    color: #b4a7cf;
    margin-bottom: 12px;
}
#post-share i {
    color: #8d4cff;
    cursor: pointer;
    margin-left: 8px;
}

/* üî±‚úîÔ∏èSite 1 ya kare daga nan ‚úîÔ∏è */



/* üî±‚úîÔ∏èSite 3 ya fara daga nan ‚úîÔ∏è */


#comments-section {
    margin-top: 22px;
}


.comment {
    
    border-radius: 0px;
    margin-bottom: 18px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: box-shadow 0.2s;
    border-left: 2px solid rgba(199, 125, 255, 0.3);
    
    
}

.comment:hover {
    background: rgba(40, 0, 60, 0.2);
    box-shadow: 0 0 10px rgba(199, 125, 255, 0.2);
}

.comment.user-owned {
    border-left: 1px solid #4dffea;
    background: rgba(40,0,80,0.15);
}


.comment .comment-header {
    display: flex;
    align-items: center;
    gap: 1px;
    margin-bottom: 6px;
    position: relative;
}

.comment .avatar {
    width: 45px; 
    height: 45px; 
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #c77dff;
    cursor: pointer;
    background: #fff;
    z-index: 1;
}

.comment .team-icon {
    width: 28px; 
    height: 28px; 
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ffecb3;
    background: #fff;
    position: absolute;
    top: -10px; 
    left: 37px; 
    z-index: 2;
}

.comment .user-info {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    position: relative;
    top: -5px;
}

.comment .full-name {
    font-weight: 600;
    font-size: 1.07em;
    color: #ffe7bb;
    max-width: 150px; 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.comment .comment-time {
    font-size: 0.6em;
    color: #c7bfff;
    position: absolute;
    right: 0;
    top: 5%;
    transform: translateY(-50%);
}

.comment .comment-body {
    margin-bottom: 1px;
    margin-left: 1px;
    font-size: 1em;
    color: #fff;
    word-break: break-word;
}

.comment .comment-media {
    margin: 2px 0 2px 50px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.comment .comment-media img,
.comment .comment-media video {
    max-width: 210px;
    max-height: 170px;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.14);
}


.comment .comment-actions .action-btn {
    background: none;
    border: none;
    color: #9f9cff;
    font-size: 1.19em;
    cursor: pointer;
    margin-right: 4px;
    transition: color 0.2s;
    border-bottom: 0.60px solid #4dffea;
}

.comment .comment-actions .action-btn.liked {
    color: #1effc1;
}

.comment .comment-actions .action-btn.seen {
    color: #ffe5a2;
}

.comment .comment-actions .action-btn.emoji {
    font-size: 1.22em;
}

.comment .comment-actions .emoji-list {
    display: flex;
    gap: 5px;
    margin-right: 7px;
    
    
}


.comment .emoji-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    top: -18px; 
    right: 15px; 
    gap: 5px;
}

.comment .emoji-container span {
    font-size: 1.3em;
    cursor: pointer;
    transition: transform 0.2s;
}

.comment .emoji-container span:hover {
    transform: scale(1.2);
}


.comment .reply-btn:hover {
    background: #33144c;
}

.comment .edit-delete-actions {
    display: flex;
    gap: 7px;
    margin-left: auto;
    margin-right: 10px;
    position: absolute;
    top: 8px;
    right: 0;
}

.comment .edit-delete-actions button {
    background: none;
    border: none;
    color: #ffe7bb;
    cursor: pointer;
    font-size: 1em;
    padding: 3px 7px;
    border-radius: 7px;
    transition: background 0.2s;
}

.comment .edit-delete-actions button:hover {
    background: #5c227c;
}



.replies {
    margin-left: 5px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.reply {
    background: rgba(80,0,120,0.1);
    border-radius: 10px;
    padding: 9px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: box-shadow 0.2s;
    border-left: 3px solid rgba(255, 236, 179, 0.3);
    margin-left: 20px; 
}

.reply:hover {
    background: rgba(80, 0, 120, 0.2);
    box-shadow: 0 0 8px rgba(255, 236, 179, 0.2);
}

.reply.user-owned {
    border-left: 1px solid #4dffea;
    background: rgba(80,0,160,0.15);
}

.reply .reply-by {
    font-size: 0.85em;
    color: #c9c7ff;
    margin-bottom: 5px;
}

.reply .reply-by span {
    color: #ffe7bb;
    font-weight: 600;
}

.reply .reply-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    position: relative;
}
.reply .avatar {
    width: 38px; 
    height: 38px; 
    border-radius: 50%;
    object-fit: cover;
    background: #fff;
    border: 2px solid #c77dff;
    z-index: 1;
}

.reply .team-icon {
    width: 22px;
    height: 22px; 
    border-radius: 50%;
    object-fit: cover;
    background: #fff;
    border: 1px solid #ffecb3;
    position: absolute;
    top: -15px;
    left: 24px; 
    z-index: 2;
}


.reply .reply-media img,
.reply .reply-media video {
    max-width: 170px;
    max-height: 140px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.09);
}


.reply .reply-actions .action-btn {
    background: none;
    border: none;
    color: #ac9cff;
    font-size: 1.09em;
    cursor: pointer;
    margin-right: 3px;
    transition: color 0.2s;
    border-bottom: 0.80px solid #4dffea;
}


.reply .reply-actions .action-btn.liked {
    color: #1effc1;
}

.reply .reply-actions .action-btn.seen {
    color: #ffe5a2;
}

.reply .reply-actions .action-btn.emoji {
    font-size: 1.14em;
}

.reply .reply-actions .emoji-list {
    display: flex;
    gap: 4px;
    margin-right: 5px;
}


.reply .emoji-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    top: -15px;
    right: 15px; 
    gap: 4px;
}

.reply .emoji-container span {
    font-size: 1.2em;
    cursor: pointer;
    transition: transform 0.2s;
}

.reply .emoji-container span:hover {
    transform: scale(1.2);
}

.reply .edit-delete-actions {
    display: flex;
    gap: 6px;
    margin-left: auto;
    margin-right: 7px;
    position: absolute;
    top: 5px;
    right: 0;
}

.reply .edit-delete-actions button {
    background: none;
    border: none;
    color: #ffe7bb;
    cursor: pointer;
    font-size: 0.98em;
    padding: 2px 6px;
    border-radius: 7px;
    transition: background 0.2s;
}

.reply .edit-delete-actions button:hover {
    background: #5c227c;
}


.comment .comment-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    position: relative; 
}

.comment .comment-time {
    font-size: 0.82em;
    color: #c7bfff;
    margin-left: auto; 
}


.comment .edit-delete-actions {
    display: flex;
    gap: 7px;
    margin-left: auto;
}


.reply .reply-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    position: relative;
}


.reply .reply-time {
    font-size: 0.7em;
    color: #b7bfff;
    margin-left: auto;
}


.reply .edit-delete-actions {
    display: flex;
    gap: 6px;
    margin-left: auto;
}


.score-prediction {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-left: 50px;
    margin-bottom: 10px;
    font-weight: 600;
    color: #ffe7bb;
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(0,0,0,0.1);
}

.score-prediction .score-team-logo {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.3);
}

.score-prediction .score-team-name {
    font-size: 0.9em;
    white-space: nowrap;
}

.score-prediction .score-value {
    font-size: 1.1em;
    color: #91fff2;
}


#emoji-container {
    position: fixed; 
    background-color: #33004a;
    border: 1px solid #c77dff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    padding: 10px;
    display: none; 
    z-index: 10000; 
    flex-wrap: wrap;
    gap: 8px; 
    max-width: 300px; 
}

#emoji-container .emoji-icon {
    cursor: pointer;
    font-size: 24px;
    padding: 6px;
    border-radius: 5px;
    transition: background-color 0.2s, transform 0.2s;
    color: #ffffff; 
    background-color: rgba(255,255,255,0.05); 
}

#emoji-container .emoji-icon:hover {
    background-color: rgba(255,255,255,0.15); 
    transform: scale(1.1);
}


#emoji-container .close-emoji-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 18px;
    color: #ff4c7d;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
}

#emoji-container .close-emoji-btn:hover {
    transform: scale(1.2);
}


.comment-media video.comment-video,
.reply-media video.reply-video {
    max-width: 100%; 
    height: auto; 
    display: block; 
    border-radius: 8px; 
    margin-top: 10px; 
    object-fit: contain; 
    border: 1px solid rgba(255,255,255,0.1); 
}


.comment-actions, .reply-actions {
    display: flex;
    flex-wrap: wrap; 
    align-items: center;
    gap: 10px; 
    margin-top: 10px;
}

.action-btn {
    background-color: #4a0072; 
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 20px; 
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s ease, transform 0.2s ease;
    display: flex; 
    align-items: center;
    gap: 5px; 
}

.action-btn:hover {
    background-color: #6a0096; 
    transform: translateY(-2px); 
}


#custom-input-modal {
    background-color: #220035e0; 
    color: #fff;
    padding: 22px 36px;
    border-radius: 14px;
    box-shadow: 0 2px 40px rgba(0,0,0,0.33);
    font-size: 1.15em;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

#custom-input-modal h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #ffe7bb;
}

#custom-input-modal span {
    display: block;
    margin-bottom: 10px;
}

#custom-input-field {
    width: calc(100% - 20px); 
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #5d257a;
    background-color: #2e0040;
    color: #fff;
    font-size: 1em;
    outline: none;
}

#custom-input-field:focus {
    border-color: #c77dff;
    box-shadow: 0 0 8px rgba(199, 125, 255, 0.5);
}

#modal-viewer .close-btn {
    position: absolute;
    top: 10px;
    right: 16px;
    color: #ffe7bb;
    font-size: 2.1em;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: color 0.2s;
}

#modal-viewer .close-btn:hover {
    color: #ff4c7d;
}

#notification-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); 
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
}

#notification-container.show {
    opacity: 1;
    pointer-events: auto;
}

.notification-box {  
    position: relative;
}

.confirmation-box {
   
}

.confirm-buttons {
    
}

.reply .reply-main-info .reply-by-user-name {
    font-size: 0.85em;
    color: #c9c7ff; 
    margin-left: 5px; 
    font-weight: normal; 
   
}


.edit-delete-actions {
    display: none; 
    gap: 8px;
    margin-top: 10px;
}

.edit-delete-actions.show-actions {
    display: flex; 
}

.edit-delete-actions button {
    background-color: #555;
    color: #fff;
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em;
    transition: background-color 0.2s ease;
}

.edit-delete-actions .edit-btn:hover {
    background-color: #007bff; 
}

/* üî±‚úîÔ∏èSite 3a ya kare daga nan, ‚úîÔ∏è */



/* üî±‚úîÔ∏èSite 4 ya fara daga nan ‚úîÔ∏è */


#footer-comment {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100vw;
    background: linear-gradient(to top, #220035dd 80%, #4e0080cc 100%);
    box-shadow: 0 -2px 16px rgba(28,0,40,0.19);
    padding: 10px 0 14px 0;
    z-index: 100;
}
#comment-container {
    max-width: 700px;
    margin: 0 auto;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding: 0 10px;
}
#upload-btn {
    background: none;
    border: none;
    color: #b4a7cf;
    font-size: 1.5em;
    cursor: pointer;
    margin-bottom: 8px;
    transition: color 0.2s;
}
#upload-btn:hover {
    color: #ffe7bb;
}
#comment-input {
    flex: 1;
    min-height: 36px;
    max-height: 110px;
    border: none;
    border-radius: 12px;
    background: #2e0040;
    color: #fff;
    font-size: 1em;
    padding: 7px 14px;
    resize: none;
    outline: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    transition: background 0.2s, box-shadow 0.2s;
}
#comment-input:focus {
    background: #380061;
    box-shadow: 0 4px 14px rgba(0,0,0,0.13);
}
#send-btn {
    background: none;
    border: none;
    color: #c77dff;
    font-size: 1.47em;
    cursor: pointer;
    margin-bottom: 8px;
    transition: color 0.2s;
    animation: send-bounce 0.9s infinite;
}
#send-btn:disabled {
    color: #7b6b9b;
    animation: none;
}
@keyframes send-bounce {
    0%   {transform: translateY(0);}
    50%  {transform: translateY(-3px);}
    100% {transform: translateY(0);}
}

/* üî±‚úîÔ∏èSite 3 ya kare daga nan ‚úîÔ∏è */

/* üî±‚úîÔ∏èSite 4 ya fara daga nan ‚úîÔ∏è */


#modal-viewer {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(18,0,32,0.87);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}
#modal-viewer.hidden {
    display: none;
}
#modal-viewer .modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}
#modal-viewer img, #modal-viewer video {
    max-width: 95vw;
    max-height: 80vh;
    border-radius: 14px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.23);
}
#modal-viewer .close-btn {
    position: absolute;
    top: 10px; right: 16px;
    color: #ffe7bb;
    font-size: 2.1em;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: color 0.2s;
}
#modal-viewer .close-btn:hover {
    color: #ff4c7d;
}
#modal-viewer .download-btn {
    position: absolute;
    bottom: 12px; right: 14px;
    color: #b4a7cf;
    font-size: 1.7em;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: color 0.2s;
}
#modal-viewer .download-btn:hover {
    color: #ffe7bb;
}
/* üî±‚úîÔ∏èSite 4 ya kare daga nan ‚úîÔ∏è */



.comment-learnmore {
    color: #4dffea; 
    font-weight: 700;
    cursor: pointer;
    font-size: 0.95em; 
    text-decoration: underline;
    margin-left: 0.3em;
    white-space: nowrap; 
}


.comment-body,
.reply-body {
    overflow: visible !important;
    display: block !important; 
    -webkit-line-clamp: unset !important; 
    -webkit-box-orient: unset !important;
}
    </style>

   
</head>
<body>
    <!-- üî±‚úîÔ∏èSite 1, ya fara daga nan, ‚úîÔ∏è -->
    <div id="main-container">
       
        <div id="post-banner"></div>

       
        <div id="post-content"></div>

        <!-- Post Meta -->
        <div id="post-meta">
            <span id="post-time"></span>
            <span id="post-share"></span>
        </div>

        <!-- üî±‚úîÔ∏èSite 1 ya kare daga nan ‚úîÔ∏è -->

        <!-- üî±‚úîÔ∏èSite 2 ya fara daga nan ‚úîÔ∏è -->
        <div id="comments-section">
         
        </div>
        <!-- üî±‚úîÔ∏èSite 2 ya kare daga nan ‚úîÔ∏è -->
    </div>
    
    
<div id="emoji-container">   
</div>


<div id="notification-container">
</div>


<div id="modal-viewer" class="hidden">   
</div>

    <!-- üî±‚úîÔ∏èSite 3 ya fara daga nan ‚úîÔ∏è -->
    <footer id="footer-comment">
        <div id="comment-container">
            <button id="upload-btn" title="Upload Media"><i class="fas fa-plus"></i></button>
            <textarea id="comment-input" placeholder="Rubuta text..."></textarea>
            <button id="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
        </div>
        <input type="file" id="file-upload" accept="image/*,video/*" multiple style="display:none;">
    </footer>
    <!-- üî±‚úîÔ∏èSite 3 ya kare daga nan ‚úîÔ∏è -->

 
<script type="module">
  import { app, analytics, firebaseConfig } from './firebase.js';
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import { getDatabase, ref, get, set, push, update, remove, child, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  const db = getDatabase();
  const auth = getAuth();
  let currentUser = null;
  let postId = null;
  let postData = null;
  let commentsCache = {};
  let replyingToOriginalCommentId = null;
  let replyingToParentReplyId = null;
  const MAX_COMMENT_TEXT_LENGTH = 280;
  const urlParams = new URLSearchParams(window.location.search);
  
  postId = urlParams.get('postId') || localStorage.getItem('site8_currentPostId');
  
  if (postId) {
    localStorage.setItem('site8_currentPostId', postId);
  } else {
    showNotification("Ba a samu Post ID ba!");
  }
  
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      loadPostData();
      listenCommentsRealtime();
    } else {
      showNotification("Da fatan za a shiga asusunka don ganin wannan shafi.");
    }
  });

  function loadPostData() {
    const postRef = ref(db, `Posting/${postId}`);
    get(postRef).then(snapshot => {
      if (snapshot.exists()) {
        postData = snapshot.val();
        renderPost(postData);
        localStorage.setItem(`post_${postId}_data`, JSON.stringify(postData));
      } else {
        const postContent = document.getElementById('post-content');
        if (postContent) {
          postContent.textContent = "Ba a samu post ba.";
        }
      }
    });
  }

  function renderPost(data) {
    const banner = document.getElementById('post-banner');
    if (banner) {
      banner.innerHTML = '';
      if (data.photoLink1 && data.photoLink2) {
        banner.innerHTML = `
          <img src="${data.photoLink1}" class="banner-img" alt="Photo 1" onerror="this.style.display='none'">
          <img src="${data.photoLink2}" class="banner-img" alt="Photo 2" onerror="this.style.display='none'">
        `;
      } else if (data.photoLink1) {
        banner.innerHTML = `<img src="${data.photoLink1}" class="banner-img" alt="Photo 1" onerror="this.style.display='none'">`;
      } else if (data.videoLink) {
        banner.innerHTML = `<video src="${data.videoLink}" class="banner-video" controls onerror="this.style.display='none'"></video>`;
      } else {
        banner.innerHTML = '';
      }
      banner.querySelectorAll('img, video').forEach(media => {
        media.onclick = () => {
          if (media.tagName.toLowerCase() === 'img') {
            showImageViewer(media.src);
          } else if (media.tagName.toLowerCase() === 'video') {
            showVideoViewer(media.src);
          }
        };
      });
    }

    const content = document.getElementById('post-content');
    if (content) {
      content.textContent = data.text || "";
    }

    const postTimeElement = document.getElementById('post-time');
    if (postTimeElement) {
      let formattedTime = '';
      try {
        const postingDate = new Date(data.postingTime);
        if (!isNaN(postingDate.getTime())) {
          formattedTime = formatTime(data.postingTime);
        } else {
          console.warn("Invalid postingTime format:", data.postingTime);
          formattedTime = 'Lokacin post ba a tantance ba';
        }
      } catch (e) {
        console.error("Error parsing postingTime:", e);
        formattedTime = 'Lokacin post ba a tantance ba';
      }
      postTimeElement.textContent = formattedTime;
    }

    const postShare = document.getElementById('post-share');
    if (postShare) {
      postShare.innerHTML = `<i class="fas fa-share" title="Share"></i>`;
      postShare.onclick = async () => {
        const shareUrl = `${window.location.origin}${window.location.pathname}?postid=${postId}`;
        const shareTitle = data.text ? data.text.substring(0, 50) + '...' : 'Sabon Post daga Tauraron Wasa';
        if (navigator.share) {
          try {
            await navigator.share({
              title: shareTitle,
              url: shareUrl
            });
            showNotification("An raba post …óin!");
          } catch (error) {
            if (error.name === 'AbortError') {
              console.log('Share was cancelled by the user.');
            } else {
              console.error('Error sharing:', error);
              showNotification("An kasa raba post …óin. Da fatan za a sake gwadawa.");
            }
          }
        } else {
          if (navigator.clipboard) {
            try {
              await navigator.clipboard.writeText(shareUrl);
              showNotification("Link …óin an kwafe shi!");
            } catch (err) {
              console.error('Failed to copy text: ', err);
              showNotification("An kasa kwafa link …óin.");
            }
          } else {
            const textArea = document.createElement("textarea");
            textArea.value = shareUrl;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
              document.execCommand('copy');
              showNotification("Link …óin an kwafe shi!");
            } catch (err) {
              console.error('Fallback: Oops, unable to copy', err);
              showNotification("An kasa kwafa link …óin.");
            }
            document.body.removeChild(textArea);
          }
        }
      };
    }
  }

  const commentInput = document.getElementById('comment-input');
  const uploadBtn = document.getElementById('upload-btn');
  const sendBtn = document.getElementById('send-btn');
  const fileUpload = document.getElementById('file-upload');
  let selectedFiles = [];

  if (uploadBtn) uploadBtn.addEventListener('click', () => fileUpload.click());
  if (fileUpload) fileUpload.addEventListener('change', e => {
    selectedFiles = Array.from(e.target.files).slice(0, 3);
    if (sendBtn) sendBtn.disabled = !commentInput.value.trim() && selectedFiles.length === 0;
  });
  if (commentInput) commentInput.addEventListener('input', () => {
    commentInput.style.height = '36px';
    commentInput.style.height = Math.min(commentInput.scrollHeight, 110) + 'px';
    if (sendBtn) sendBtn.disabled = !commentInput.value.trim() && selectedFiles.length === 0;
  });
  if (sendBtn) sendBtn.addEventListener('click', handleSendComment);

  async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          if (response.status >= 500 || !response.status) {
            throw new Error(`Server error or network issue: ${response.status || 'No Status'}`);
          } else {
            console.warn(`Client error, no retry: ${response.status} - ${await response.text()}`);
            return null;
          }
        }
        return response;
      } catch (error) {
        console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying...`);
        if (i < retries - 1) {
          await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
        }
      }
    }
    console.error(`All ${retries} fetch retries failed for ${url}.`);
    return null;
  }

  async function sendUserNotification(recipientUid, senderData, replyTextSnippet, originalCommentId, parentReplyId) {
    try {
      const recipientUserRef = ref(db, `users/${recipientUid}`);
      const recipientSnapshot = await get(recipientUserRef);
      const recipientData = recipientSnapshot.exists() ? recipientSnapshot.val() : null;
      
      if (!recipientData || !recipientData.subscription || !recipientData.userIpAddress) {
        console.warn(`Recipient ${recipientUid} does not have complete notification data (subscription, IP, or full name).`);
        return;
      }
      
      const recipientSubscription = recipientData.subscription;
      const recipientIpAddress = recipientData.userIpAddress;
      const recipientFullName = recipientData.fullName || 'Unknown User';
      
      const payload = {
        recipientSubscription: recipientSubscription,
        recipientFullName: recipientFullName,
        recipientIpAddress: recipientIpAddress,
        title: `Sabon Reply Daga ${senderData.fullName}`,
        body: replyTextSnippet.substring(0, 100) + (replyTextSnippet.length > 100 ? '...' : ''),
        icon: senderData.profileLogo,
        badge: senderData.teamLogo,
        url: `${window.location.origin}${window.location.pathname}?postid=${postId}#comment-${originalCommentId}`,
      };

      if (parentReplyId) {
        payload.body = `Reply ga Reply: ${replyTextSnippet.substring(0, 100)}${(replyTextSnippet.length > 100 ? '...' : '')}`;
      }
      
      console.log("Sending notification payload:", payload);
      const response = await fetchWithRetry('https://worker33.workers.dev/userNotification', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });
      
      if (response && response.ok) {
        console.log("Notification sent successfully to worker.");
      } else {
        console.warn("Failed to send notification to worker.");
      }
    } catch (error) {
      console.error("Error in sendUserNotification:", error);
    }
  }

  async function handleSendComment() {
    if (!currentUser) return;
    if (sendBtn) sendBtn.disabled = true;
    
    let commentMediaLinks = {
      images: [],
      video: null
    };
    let commentText = commentInput ? commentInput.value.trim() : '';

    if (!commentText && selectedFiles.length === 0) {
      if (sendBtn) sendBtn.disabled = false;
      return;
    }

    if (selectedFiles.length > 0) {
      for (const file of selectedFiles) {
        const formData = new FormData();
        formData.append("image", file);
        try {
          const response = await fetch("https://api.imgur.com/3/image", {
            method: "POST",
            headers: {
              Authorization: "Client-ID 5acf7eff9c91660"
            },
            body: formData
          });
          const data = await response.json();
          if (data.success && data.data && data.data.link) {
            if (file.type.startsWith("image/")) {
              commentMediaLinks.images.push(data.data.link);
            } else if (file.type.startsWith("video/")) {
              commentMediaLinks.video = data.data.link;
            }
          } else {
            console.error("Imgur upload failed for file:", file.name, data);
            showNotification(`An kasa loda hoton/bidiyon '${file.name}'.`);
          }
        } catch (uploadError) {
          console.error("Error uploading to Imgur:", uploadError);
          showNotification(`An sami kuskure wajen loda hoton/bidiyon '${file.name}'.`);
        }
      }
    }

    try {
      const commentsRef = ref(db, `Posting/${postId}/Comments`);
      let recipientUidForNotification = null;

      if (replyingToOriginalCommentId) {
        const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);
        if (originalComment) {
          if (replyingToParentReplyId) {
            if (originalComment.replies) {
              const parentReply = Object.values(originalComment.replies).find(r => r.id === replyingToParentReplyId);
              if (parentReply) {
                recipientUidForNotification = parentReply.userId;
              }
            }
          } else {
            recipientUidForNotification = originalComment.userId;
          }
        }
        
        let replyObj = {
          userId: currentUser.uid,
          avatarUrl: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
          supportTeams: postData.userTeamLogo || '',
          fullName: currentUser.displayName || 'Unknown User',
          commentText: commentText,
          imageLink1: commentMediaLinks.images[0] || '',
          imageLink2: commentMediaLinks.images[1] || '',
          imageLink3: commentMediaLinks.images[2] || '',
          videoComment: commentMediaLinks.video || '',
          replyTime: new Date().toISOString(),
          replyLike: 0,
          userFirebaseUid: currentUser.uid,
          replyingToCommentId: replyingToOriginalCommentId,
          replyingToReplyId: replyingToParentReplyId,
        };

        if (replyingToParentReplyId) {
          const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);
          if (originalComment && originalComment.replies) {
            const parentReply = Object.values(originalComment.replies).find(r => r.id === replyingToParentReplyId);
            if (parentReply) {
              replyObj.replyingToReplyUserFullName = parentReply.fullName;
            }
          }
        } else {
          const originalComment = commentsCache.find(c => c.id === replyingToOriginalCommentId);
          if (originalComment) {
            replyObj.replyingToReplyUserFullName = originalComment.fullName;
          }
        }
        
        const repliesRef = child(commentsRef, `${replyingToOriginalCommentId}/replies`);
        const newReplyRef = push(repliesRef);
        await set(newReplyRef, replyObj);
        
        if (recipientUidForNotification && recipientUidForNotification !== currentUser.uid) {
          const senderData = {
            fullName: currentUser.displayName || 'Unknown User',
            profileLogo: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
            teamLogo: postData.userTeamLogo || 'https://i.imgur.com/CgvdgMA.png',
          };
          await sendUserNotification(recipientUidForNotification, senderData, commentText, replyingToOriginalCommentId, replyingToParentReplyId);
        }
      } else {
        const commentObj = {
          userId: currentUser.uid,
          avatarUrl: currentUser.photoURL || 'https://i.imgur.com/CgvdgMA.png',
          supportTeams: postData.userTeamLogo || '',
          fullName: currentUser.displayName || 'Unknown User',
          commentText: commentText,
          imageLink1: commentMediaLinks.images[0] || '',
          imageLink2: commentMediaLinks.images[1] || '',
          imageLink3: commentMediaLinks.images[2] || '',
          videoComment: commentMediaLinks.video || '',
          commentTime: new Date().toISOString(),
          commentLike: 0,
          commentEmoji: '',
          replies: {},
          userFirebaseUid: currentUser.uid,
        };
        const newCommentRef = push(commentsRef);
        await set(newCommentRef, commentObj);
      }

      const totalCommentRef = ref(db, `Posting/${postId}/totalComment`);
      await runTransaction(totalCommentRef, (currentValue) => {
        return (currentValue || 0) + 1;
      });
    } catch (err) {
      console.warn("Kuskure wajen ajiye comment:", err);
    }
    
    if (commentInput) {
      commentInput.value = '';
      commentInput.style.height = '36px';
      commentInput.placeholder = "Rubuta comment‚Ä¶";
    }
    replyingToOriginalCommentId = null;
    replyingToParentReplyId = null;
    selectedFiles = [];
    if (fileUpload) fileUpload.value = '';
    if (sendBtn) sendBtn.disabled = false;
  }

  function listenCommentsRealtime() {
    const commentsRef = ref(db, `Posting/${postId}/Comments`);
    onValue(commentsRef, snapshot => {
      let comments = [];
      snapshot.forEach(childSnap => {
        let comment = childSnap.val();
        comment.id = childSnap.key;
        comments.unshift(comment);
      });
      commentsCache = comments;
      renderComments(comments);
    });
  }

  function renderComments(comments) {
    const section = document.getElementById('comments-section');
    if (!section) return;
    section.innerHTML = '';
    comments.forEach(comment => {
      section.append(renderComment(comment));
    });
  }

  function renderComment(comment) {
    const div = document.createElement('div');
    div.className = `comment ${comment.userId === currentUser.uid ? 'user-owned' : ''}`;
    div.dataset.commentId = comment.id;
  
    let commentBodyText = comment.commentText || '';
    let displayCommentText = commentBodyText;
    let hasMoreCommentText = false;
  
    if (commentBodyText.length > MAX_COMMENT_TEXT_LENGTH) {
      displayCommentText = commentBodyText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...';
      hasMoreCommentText = true;
    }
  
    div.innerHTML = `
      <div class="comment-header">
        <div class="avatar-wrapper">
          <img src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="avatar" data-profile-src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
          <img src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" class="team-icon" data-profile-src="${comment.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${comment.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
        </div>
        <div class="comment-main-info">
          <span class="full-name">${comment.fullName}</span>
          <span class="comment-time">${formatTime(comment.commentTime)}</span>
        </div>
      </div>
      <div class="comment-body" data-fulltext="${encodeURIComponent(commentBodyText)}">
        ${displayCommentText}
        ${hasMoreCommentText ? `<span class="comment-learnmore">Kara Karantawa</span>` : ''}
      </div>
      <div class="comment-media">
        ${comment.imageLink1 ? `<img src="${comment.imageLink1}" class="comment-img" onerror="this.style.display='none'" />` : ''}
        ${comment.imageLink2 ? `<img src="${comment.imageLink2}" class="comment-img" onerror="this.style.display='none'" />` : ''}
        ${comment.imageLink3 ? `<img src="${comment.imageLink3}" class="comment-img" onerror="this.style.display='none'" />` : ''}
        ${comment.videoComment ? `<video src="${comment.videoComment}" class="comment-video" controls onerror="this.style.display='none'"></video>` : ''}
      </div>
      <div class="comment-actions">
        <button class="action-btn like-btn">Like. ${comment.commentLike || 0}</button>
        <button class="action-btn emoji-btn">Emoji <span class="emoji-text">${comment.commentEmoji || ''}</span></button>
        <button class="action-btn reply-btn">Reply</button>
        ${comment.userId === currentUser.uid ? `<button class="action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
      </div>
      <div class="edit-delete-actions" style="display: none;">
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
      </div>
    `;

    const commentBodyElement = div.querySelector('.comment-body');
    const commentLearnMoreBtn = commentBodyElement ? commentBodyElement.querySelector('.comment-learnmore') : null;

    if (commentLearnMoreBtn) {
      commentLearnMoreBtn.addEventListener('click', () => {
        const fullText = decodeURIComponent(commentBodyElement.dataset.fulltext);
        commentBodyElement.innerHTML = fullText;
      });
    }

    div.querySelectorAll('.comment-img').forEach(img => {
      img.onclick = () => showImageViewer(img.src);
    });

    div.querySelectorAll('.comment-video').forEach(video => {
      video.onclick = () => showVideoViewer(video.src);
    });

    const likeBtn = div.querySelector('.like-btn');
    if (likeBtn) likeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleLike(comment.id);
    });

    const replyBtn = div.querySelector('.reply-btn');
    if (replyBtn) replyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleReply(comment.id);
    });

    const emojiBtn = div.querySelector('.emoji-btn');
    if (emojiBtn) emojiBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleEmojiClick(e, comment.id, 'comment');
    });

    const moreOptionsBtn = div.querySelector('.more-options-btn');
    const editDeleteActionsDiv = div.querySelector('.edit-delete-actions');
    if (moreOptionsBtn) {
      moreOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
          editDeleteActionsDiv.classList.toggle('show-actions');
        }
      });
    }

    const avatar = div.querySelector('.avatar');
    const teamIcon = div.querySelector('.team-icon');
    if (avatar) avatar.onclick = (e) => showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);
    if (teamIcon) teamIcon.onclick = (e) => showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);

    if (comment.userId === currentUser.uid) {
      const editBtn = div.querySelector('.edit-btn');
      if (editBtn) editBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newText = await showInputModal("Gyara comment:", "Rubuta sabon comment din ka:", comment.commentText);
        if (newText !== null && newText.trim() !== "") {
          handleEdit(comment.id, newText);
        }
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });

      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleDelete(comment.id);
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
    }

    const repliesDiv = document.createElement('div');
    repliesDiv.className = 'replies';
    if (comment.replies) {
      const sortedReplies = Object.values(comment.replies).sort((a, b) => new Date(a.replyTime) - new Date(b.replyTime));
      sortedReplies.forEach(reply => {
        reply.id = Object.keys(comment.replies).find(key => comment.replies[key] === reply); 
        repliesDiv.append(renderReply(reply, comment));
      });
    }

    div.append(repliesDiv);
    return div;
  }

  function renderReply(reply, parentComment) {
    const div = document.createElement('div');
    div.className = `reply ${reply.userId === currentUser.uid ? 'user-owned' : ''}`;
    div.dataset.replyId = reply.id;
    
    let replyingToHtml = '';
    if (reply.replyingToReplyUserFullName) {
      replyingToHtml = `<span class="reply-by-user-name">Replying to ${reply.replyingToReplyUserFullName}</span>`;
    } else {
      replyingToHtml = `<span class="reply-by-user-name">Replying to ${parentComment.fullName}</span>`;
    }
    
    let replyBodyText = reply.commentText || '';
    let displayReplyText = replyBodyText;
    let hasMoreReplyText = false;
    
    if (replyBodyText.length > MAX_COMMENT_TEXT_LENGTH) {
      displayReplyText = replyBodyText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...';
      hasMoreReplyText = true;
    }
    
    div.innerHTML = `
      <div class="reply-header">
        <div class="avatar-wrapper">
          <img src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="avatar" data-profile-src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
          <img src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" class="team-icon" data-profile-src="${reply.avatarUrl || 'https://i.imgur.com/CgvdgMA.png'}" data-team-src="${reply.supportTeams || 'https://i.imgur.com/CgvdgMA.png'}" />
        </div>
        <div class="reply-main-info">
          <span class="full-name">${reply.fullName}</span>
          ${replyingToHtml}
          <span class="reply-time">${formatTime(reply.replyTime)}</span>
        </div>
      </div>
      <div class="reply-body" data-fulltext="${encodeURIComponent(replyBodyText)}">
        ${displayReplyText}
        ${hasMoreReplyText ? `<span class="comment-learnmore">Kara Karantawa</span>` : ''}
      </div>
      <div class="reply-media">
        ${reply.imageLink1 ? `<img src="${reply.imageLink1}" class="reply-img" onerror="this.style.display='none'" />` : ''}
        ${reply.imageLink2 ? `<img src="${reply.imageLink2}" class="reply-img" onerror="this.style.display='none'" />` : ''}
        ${reply.imageLink3 ? `<img src="${reply.imageLink3}" class="reply-img" onerror="this.style.display='none'" />` : ''}
        ${reply.videoComment ? `<video src="${reply.videoComment}" class="reply-video" controls onerror="this.style.display='none'"></video>` : ''}
      </div>
      <div class="reply-actions">
        <button class="action-btn like-btn">Like. ${reply.replyLike || 0}</button>
        <button class="action-btn reply-btn">Reply</button>
        ${reply.userId === currentUser.uid ? `<button class="action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
      </div>
      <div class="edit-delete-actions" style="display: none;">
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
      </div>
    `;

    const replyBodyElement = div.querySelector('.reply-body');
    const replyLearnMoreBtn = replyBodyElement ? replyBodyElement.querySelector('.comment-learnmore') : null;
    if (replyLearnMoreBtn) {
      replyLearnMoreBtn.addEventListener('click', () => {
        const fullText = decodeURIComponent(replyBodyElement.dataset.fulltext);
        replyBodyElement.innerHTML = fullText;
      });
    }

    div.querySelectorAll('.reply-img').forEach(img => {
      img.onclick = () => showImageViewer(img.src);
    });

    div.querySelectorAll('.reply-video').forEach(video => {
      video.onclick = () => showVideoViewer(video.src);
    });

    const likeBtn = div.querySelector('.like-btn');
    if (likeBtn) likeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleLikeReply(parentComment.id, reply.id);
    });

    const replyBtn = div.querySelector('.reply-btn');
    if (replyBtn) replyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      handleReply(parentComment.id, reply.id);
    });

    const moreOptionsBtn = div.querySelector('.more-options-btn');
    const editDeleteActionsDiv = div.querySelector('.edit-delete-actions');
    if (moreOptionsBtn) {
      moreOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
          editDeleteActionsDiv.classList.toggle('show-actions');
        }
      });
    }

    const avatar = div.querySelector('.avatar');
    const teamIcon = div.querySelector('.team-icon');
    if (avatar) avatar.onclick = (e) => showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);
    if (teamIcon) teamIcon.onclick = (e) => showProfileViewer(e.target.dataset.profileSrc, e.target.dataset.teamSrc);

    if (reply.userId === currentUser.uid) {
      const editBtn = div.querySelector('.edit-btn');
      if (editBtn) editBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newText = await showInputModal("Gyara reply:", "Rubuta sabon reply din ka:", reply.commentText);
        if (newText !== null && newText.trim() !== "") {
          handleEditReply(parentComment.id, reply.id, newText);
        }
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });

      const deleteBtn = div.querySelector('.delete-btn');
      if (deleteBtn) deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleDeleteReply(parentComment.id, reply.id);
        if (editDeleteActionsDiv) {
          editDeleteActionsDiv.style.display = 'none';
          editDeleteActionsDiv.classList.remove('show-actions');
        }
      });
    }
    return div;
  }

  function handleLike(commentId) {
    const commentRef = ref(db, `Posting/${postId}/Comments/${commentId}`);
    runTransaction(commentRef, (comment) => {
      if (comment) {
        if (!comment.commentLike) {
          comment.commentLike = 0;
        }
        comment.commentLike++;
      }
      return comment;
    });
  }

  function handleLikeReply(commentId, replyId) {
    const replyRef = ref(db, `Posting/${postId}/Comments/${commentId}/replies/${replyId}`);
    runTransaction(replyRef, (reply) => {
      if (reply) {
        if (!reply.replyLike) {
          reply.replyLike = 0;
        }
        reply.replyLike++;
      }
      return reply;
    });
  }

  function handleReply(commentId, parentReplyId = null) {
    replyingToOriginalCommentId = commentId;
    replyingToParentReplyId = parentReplyId;
    const originalComment = commentsCache.find(c => c.id === commentId);
    let targetUserName = originalComment ? originalComment.fullName : 'Unknown User';
    if (parentReplyId) {
      if (originalComment && originalComment.replies) {
        const parentReply = Object.values(originalComment.replies).find(r => r.id === parentReplyId);
        if (parentReply) {
          targetUserName = parentReply.fullName;
        }
      }
    }
    if (commentInput) {
      commentInput.placeholder = `Replying to ${targetUserName}...`;
      commentInput.focus();
    }
  }

  function handleEmojiClick(event, commentId, type) {
    event.stopPropagation();
    const emojiContainer = document.getElementById('emoji-container');
    if (!emojiContainer) {
      console.error("Emoji container not found. Make sure you have a div with id 'emoji-container' in your HTML.");
      return;
    }
    const rect = event.currentTarget.getBoundingClientRect();
    emojiContainer.style.position = 'fixed';
    let topPosition = rect.bottom + 10;
    if (topPosition + emojiContainer.offsetHeight > window.innerHeight && rect.top - emojiContainer.offsetHeight - 10 > 0) {
      topPosition = rect.top - emojiContainer.offsetHeight - 10;
    }
    emojiContainer.style.top = `${topPosition}px`;
    emojiContainer.style.left = `${rect.left}px`;
    emojiContainer.style.transform = 'translateX(0)';
    if (rect.left + emojiContainer.offsetWidth > window.innerWidth) {
      emojiContainer.style.left = `${window.innerWidth - emojiContainer.offsetWidth - 10}px`;
    }
    emojiContainer.style.maxWidth = '300px';
    emojiContainer.style.display = 'flex';
    emojiContainer.classList.add('show');
    const emojiIcons = ['üëç', 'ü§¶‚Äç‚ôÄÔ∏è', 'üëÅÔ∏è', '‚ùå', 'üôÜ‚Äç‚ôÇÔ∏è', 'ü§ö', 'ü§ú', 'üòÜ', 'üòÑ', 'üò†', 'üò°', 'üëπ', 'üôâ', 'üíû', '‚ù§Ô∏è', 'üíØ', 'üí•', 'üë©‚Äçüé§', 'üë©‚Äçüåæ', 'üôã‚Äç‚ôÄÔ∏è', 'üêí', 'ü¶ç', 'üê´', 'ü¶ì', 'ü¶Ñ', 'üêü', '‚öΩ', 'üèÖ', 'üèÜ', 'ü•á', 'üéâ', 'üéä', 'üéÅ'];
    let emojiHtml = `<span class="emoji-icon close-emoji-btn">‚ùå</span>`;
    emojiHtml += emojiIcons.map(icon => `<span class="emoji-icon">${icon}</span>`).join('');
    emojiContainer.innerHTML = emojiHtml;
    emojiContainer.querySelectorAll('.emoji-icon').forEach(icon => {
      icon.onclick = (e) => {
        e.stopPropagation();
        emojiContainer.style.display = 'none';
        emojiContainer.classList.remove('show');
        if (!icon.classList.contains('close-emoji-btn')) {
          updateEmoji(commentId, icon.textContent, type);
        }
      };
    });
  }

  function updateEmoji(commentId, emoji, type) {
    let path = `Posting/${postId}/Comments/${commentId}`;
    if (type === 'comment') {
      const emojiRef = ref(db, path);
      update(emojiRef, {
        [`${type}Emoji`]: emoji
      });
    }
  }

  function showInputModal(title, message, defaultValue = '') {
    return new Promise((resolve) => {
      const modalHtml = `
        <div id="custom-input-modal" class="notification-box confirmation-box">
          <h3>${title}</h3>
          <span>${message}</span>
          <input type="text" id="custom-input-field" value="${defaultValue}" style="width: 90%; padding: 8px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc;"/>
          <div class="confirm-buttons" style="margin-top: 15px;">
            <button id="input-confirm-ok" style="background-color: #28a745;">OK</button>
            <button id="input-confirm-cancel" style="background-color: #dc3545;">A'a</button>
          </div>
        </div>
      `;
      const container = document.getElementById('notification-container');
      if (!container) {
        console.error("Notification container not found for input modal. Ensure it's in HTML and visible.");
        return resolve(null);
      }
      container.innerHTML = '';
      container.innerHTML = modalHtml;
      container.classList.add('show');
      const inputField = document.getElementById('custom-input-field');
      if (inputField) inputField.focus();
      document.getElementById('input-confirm-ok').onclick = () => {
        const value = inputField ? inputField.value : '';
        container.classList.remove('show');
        container.innerHTML = '';
        resolve(value);
      };
      document.getElementById('input-confirm-cancel').onclick = () => {
        container.classList.remove('show');
        container.innerHTML = '';
        resolve(null);
      };
    });
  }

  function handleEdit(commentId, newText) {
    const commentRef = ref(db, `Posting/${postId}/Comments/${commentId}`);
    update(commentRef, {
      commentText: newText
    });
    showNotification("An gyara comment naka.");
  }

  function handleDelete(commentId) {
    showConfirmation("Kana so ka goge wannan comment?", () => {
      const commentRef = ref(db, `Posting/${postId}/Comments/${commentId}`);
      remove(commentRef).then(() => {
        showNotification("An goge comment naka.");
      }).catch(error => {
        console.error("Kuskure wajen goge comment:", error);
        showNotification("An kasa goge comment.");
      });
    });
  }

  function handleEditReply(commentId, replyId, newText) {
    const replyRef = ref(db, `Posting/${postId}/Comments/${commentId}/replies/${replyId}`);
    update(replyRef, {
      commentText: newText
    });
    showNotification("An gyara reply naka.");
  }

  function handleDeleteReply(commentId, replyId) {
    showConfirmation("Kana so ka goge wannan reply?", () => {
      const replyRef = ref(db, `Posting/${postId}/Comments/${commentId}/replies/${replyId}`);
      remove(replyRef).then(() => {
        showNotification("An goge reply naka.");
      }).catch(error => {
        console.error("Kuskure wajen goge reply:", error);
        showNotification("An kasa goge reply.");
      });
    });
  }

  window.showNotification = function(message) {
    const container = document.getElementById('notification-container');
    if (!container) {
      console.error("Notification container not found for notification. Ensure it's in HTML and visible.");
      return;
    }
    container.innerHTML = '';
    const notificationBox = document.createElement('div');
    notificationBox.className = 'notification-box';
    notificationBox.textContent = message;
    container.append(notificationBox);
    container.classList.add('show');
    setTimeout(() => {
      container.classList.remove('show');
      container.innerHTML = '';
    }, 5000);
  }

  window.showConfirmation = function(message, onConfirm) {
    const container = document.getElementById('notification-container');
    if (!container) {
      console.error("Notification container not found for confirmation. Ensure it's in HTML and visible.");
      return;
    }
    container.innerHTML = '';
    const confirmationBox = document.createElement('div');
    confirmationBox.className = 'notification-box confirmation-box';
    confirmationBox.innerHTML = `
      <span>${message}</span>
      <div class="confirm-buttons">
        <button id="confirm-yes">Eh</button>
        <button id="confirm-no">A'a</button>
      </div>
    `;
    container.append(confirmationBox);
    container.classList.add('show');
    const confirmYesBtn = document.getElementById('confirm-yes');
    if (confirmYesBtn) {
      confirmYesBtn.onclick = () => {
        onConfirm();
        container.classList.remove('show');
        container.innerHTML = '';
      };
    }
    const confirmNoBtn = document.getElementById('confirm-no');
    if (confirmNoBtn) {
      confirmNoBtn.onclick = () => {
        container.classList.remove('show');
        container.innerHTML = '';
      };
    }
  }

  window.showImageViewer = function(src) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) return;
    modal.innerHTML = `
      <div class="modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <img src="${src}" alt="Image" onerror="this.src='https://placehold.co/400x300/e0e0e0/000000?text=Hoton+Baya+Nan'" />
        <button class="download-btn" title="Download"><i class="fas fa-download"></i></button>
      </div>
    `;
    modal.classList.remove('hidden');
    const closeBtn = modal.querySelector('.close-btn');
    if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
    const downloadBtn = modal.querySelector('.download-btn');
    if (downloadBtn) downloadBtn.onclick = () => downloadMedia(src, 'image');
  }

  window.showVideoViewer = function(src) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) return;
    modal.innerHTML = `
      <div class="modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <video src="${src}" controls autoplay onerror="this.src=''" onplay="this.onerror=null; console.warn('Video not loaded, check URL/format');"></video>
        <button class="download-btn" title="Download"><i class="fas fa-download"></i></button>
      </div>
    `;
    modal.classList.remove('hidden');
    const closeBtn = modal.querySelector('.close-btn');
    if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
    const downloadBtn = modal.querySelector('.download-btn');
    if (downloadBtn) downloadBtn.onclick = () => downloadMedia(src, 'video');
  }

  window.showProfileViewer = function(profileUrl, teamUrl) {
    const modal = document.getElementById('modal-viewer');
    if (!modal) return;
    modal.innerHTML = `
      <div class="profile-modal-content">
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <img src="${profileUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="profile-image-fullscreen" alt="Profile Image" onerror="this.src='https://i.imgur.com/CgvdgMA.png'" />
        <img src="${teamUrl || 'https://i.imgur.com/CgvdgMA.png'}" class="team-logo-overlay" alt="Team Logo" onerror="this.src='https://i.imgur.com/CgvdgMA.png'" />
      </div>
    `;
    modal.classList.remove('hidden');
    const closeBtn = modal.querySelector('.close-btn');
    if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
  }

  function downloadMedia(src, type) {
    const link = document.createElement('a');
    link.href = src;
    link.download = (type === 'image' || type === 'img') ? 'image.jpg' : 'video.mp4';
    link.click();
  }

  function formatTime(dateStr) {
    const dt = new Date(dateStr);
    return dt.toLocaleString('ha-NG', {
      hour12: true
    });
  }

  document.addEventListener('click', (event) => {
    const emojiContainer = document.getElementById('emoji-container');
    if (emojiContainer && emojiContainer.style.display === 'flex') {
      if (!emojiContainer.contains(event.target) && !event.target.closest('.emoji-btn')) {
        emojiContainer.style.display = 'none';
        emojiContainer.classList.remove('show');
      }
    }
  });
</script>    
</body>
</html>
